<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.user.UserCountMapper">
    <insert id="upsertDeltaCountBatch">
        INSERT INTO user_count
        (user_id, read_cnt, like_cnt, collect_cnt, comment_cnt, fan_cnt, follow_cnt, update_time)
        VALUES
        <foreach collection="userCountList" item="item" separator=",">
            (#{item.userId},
            <if test="item.readCnt != null">#{item.readCnt}</if>
            <if test="item.readCnt == null">0</if>,
            <if test="item.likeCnt != null">#{item.likeCnt}</if>
            <if test="item.likeCnt == null">0</if>,
            <if test="item.collectCnt != null">#{item.collectCnt}</if>
            <if test="item.collectCnt == null">0</if>,
            <if test="item.commentCnt != null">#{item.commentCnt}</if>
            <if test="item.commentCnt == null">0</if>,
            <if test="item.fanCnt != null">#{item.fanCnt}</if>
            <if test="item.fanCnt == null">0</if>,
            <if test="item.followCnt != null">#{item.followCnt}</if>
            <if test="item.followCnt == null">0</if>,
            NOW())
        </foreach>
        ON DUPLICATE KEY UPDATE
        read_cnt    = GREATEST(IFNULL(read_cnt,0)    + VALUES(read_cnt),    0),
        like_cnt    = GREATEST(IFNULL(like_cnt,0)    + VALUES(like_cnt),    0),
        collect_cnt = GREATEST(IFNULL(collect_cnt,0) + VALUES(collect_cnt), 0),
        comment_cnt = GREATEST(IFNULL(comment_cnt,0) + VALUES(comment_cnt), 0),
        fan_cnt     = GREATEST(IFNULL(fan_cnt,0)     + VALUES(fan_cnt),     0),
        follow_cnt  = GREATEST(IFNULL(follow_cnt,0)  + VALUES(follow_cnt),  0),
        update_time = NOW()
    </insert>

    <select id="getArticleCountBatch">
        SELECT user_id AS userId, read_cnt AS readCnt,like_cnt AS likeCnt,collect_cnt AS collectCnt,
        comment_cnt AS commentCnt, fan_cnt AS fanCnt, follow_cnt AS follow_cnt
        FROM user_count
        <where>
            user_id IN
            <foreach collection="userIds" separator="," open="(" close=")" item="userId">
                #{userId}
            </foreach>
        </where>
    </select>
</mapper>
