# 数据库设计文档

| 序号 | 数据表名        | 中文名称       |
| ---- | --------------- | -------------- |
| 1    | user            | 用户基础信息   |
| 2    | user\_info      | 用户详细信息表 |
| 3    | user\_relation  | 用户关系  |
| 4    | user-count | 用户计数     |
| 5    | article         | 文章表          |
| 6    | article\_detail | 文章详情表      |
| 7    | category        | 文章类别       |
| 8    | tag             | 文章标签       |
| 9    | article\_tag    | 文章标签映射   |
| 10 | article_interaction | 文章交互记录表 |
| 11  | article\_count | 文章阅读计数   |
| 12   | comment             | 评论内容表     |
| 13   | comment_interaction | 评论交互记录表 |
| 14   | comment_count       | 评论技术表     |
| 15   | notice_content      | 通知内容表     |
| 16  | notice_count        | 通知计数表     |
| 17 | chat_user_session | 用户聊天会话表 |
| 18   | chat_user_history   | 用户聊天消息表 |
| 19   | chat_ai_session     | ai聊天会话表   |
| 20   | chat_ai_history     | ai聊天消息表   |



## 用户相关

### 1. user

user表为用户表，存储用户的基本信息。会扩展微信扫码登录。

| 字段名           | 数据类型     | 说明         | 备注        |
| ---------------- | ------------ | ------------ | ----------- |
| id               | bigint       | 主键         | 自增        |
| third_account_id | varchar      | 三方id       |             |
| username         | varchar(32)  | 用户名       | 唯一        |
| password         | varchar(128) | 密码         |             |
| login_type       | int          | 手机号       | 0账密 1扫码 |
| deleted          | int          | 账号状态     | 1删除 0正常 |
| create_time      | datetime     | 创建时间     |             |
| update_time      | datetime     | 最后修改时间 |             |
| user_role   | int(4)           | 管理员标记   | 0 普通用户 1 管理员 |

​	

```sql
CREATE TABLE `user` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `third_account_id` varchar(64) NOT NULL DEFAULT '',
  `user_name` varchar(32) NOT NULL DEFAULT '',
  `password` varchar(128) NOT NULL DEFAULT '',
  `login_type` int NOT NULL DEFAULT '0' COMMENT '手机号',
  `deleted` int NOT NULL DEFAULT '0' COMMENT '1删除 0正常',
  `user_role` int NOT NULL DEFAULT '0',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_name` (`user_name`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户基础信息表'
```



### 2. user_info

user_info表为用户信息表，存储用户详细信息。

| 字段名       | 数据类型         | 说明         | 备注               |
| ------------ | ---------------- | ------------ | ------------------ |
| id           | int(10) unsigned | 主键         | 自增               |
| user\_id     | int(10) unsigned | 用户ID       |                    |
| user\_name   | varchar(50)      | 用户名       |                    |
| photo        | varchar(128)     | 用户头像     |                    |
| position     | varchar(50)      | 职位         |                    |
| company      | varchar(50)      | 公司         |                    |
| profile      | varchar(225)     | 个人简介     |                    |
| extend       | varchar(1024)    | 扩展字段     |                    |
| ip           | json             | 用户的ip信息 |                    |
| deleted      | tinyint(4)       | 是否删除     |                    |
| create\_time | timestamp        | 创建时间     | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间 | 默认当前时间并更新 |



```sql
CREATE TABLE `user_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `user_name` varchar(50) NOT NULL DEFAULT '',
  `photo` varchar(128) NOT NULL DEFAULT '',
  `position` varchar(50) NOT NULL DEFAULT '',
  `company` varchar(50) NOT NULL DEFAULT '',
  `profile` varchar(225) NOT NULL DEFAULT '',
  `extend` varchar(1024) NOT NULL DEFAULT '',
  `ip` json DEFAULT NULL COMMENT '用户的ip信息',
  `deleted` tinyint NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `key_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户个人信息表'
```



### 3.user_ralation

这里主要记录的是用户之间的关注关系，由关注者和被关注者的id共同决定一条关系。

个人想法是在需要粉丝和关注详情的时候查询得到对应的用户。

这个follow_state应该是前端需要渲染要用到。

| 字段名         | 数据类型         | 说明                                     | 备注               |
| -------------- | ---------------- | ---------------------------------------- | ------------------ |
| id             | int(10) unsigned | 主键                                     | 自增               |
| user_id        | int(10) unsigned | 作者用户ID                               |                    |
| follow_user_id | int(10) unsigned | 关注userId的用户id，即粉丝userId         |                    |
| follow_state   | tinyint(2)       | 阅读状态: 0-未关注，1-已关注，2-取消关注 |                    |
| create_time    | timestamp        | 创建时间                                 | 默认当前时间       |
| update_time    | timestamp        | 最后更新时间                             | 默认当前时间并更新 |



```sql
CREATE TABLE `user_relation` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `follow_user_id` int unsigned NOT NULL,
  `follow_state` tinyint unsigned NOT NULL DEFAULT '0',
  `last_follow_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '用户最后关注（业务时间）',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_follow` (`user_id`,`follow_user_id`),
  KEY `key_follow_user_id` (`follow_user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=123 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户关系表'
```



### 4. user_count 

user_count主要存储一篇文章的的被阅读、被点赞、被收藏、被评论、粉丝数、关注数。

是为了在缓存穿透后可以直接读取数量，这个数量实际可以从文章计数和粉丝关注关系中计算得到，但是那样一旦同时并发并且交互数据表大了，使用count就会直接崩溃。（后续的计数存储都是出于这样的考虑）

| 字段名       | 数据类型         | 说明           | 备注               |
| ------------ | ---------------- | -------------- | ------------------ |
| id           | int(10) unsigned | 主键ID         | 自增               |
| article_id   | int(10) unsigned | 文档ID（文章） |                    |
| read_cnt     | int(10) unsigned | 访问计数       | 默认0              |
| like_cnt     | int(10) unsigned | 点赞计数       | 默认0              |
| collect_cnt  | int(10) unsigned | 收藏计数       | 默认0              |
| comment_cnt  | int(10) unsigned | 评论计数       | 默认0              |
| report_cnt   | int(10) unsigned | 举报计数       | 默认0              |
| create\_time | timestamp        | 创建时间       | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间   | 默认当前时间并更新 |



```sql
CREATE TABLE `user_count` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `fan_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '粉丝数',
  `follow_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '关注数',
  `read_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被阅读总数',
  `comment_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被评论总数',
  `like_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被点赞总数',
  `collect_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被收藏总数',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=580 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户综合计数表'
```



### 建表汇总

```sql
CREATE TABLE `user` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `third_account_id` varchar(64) NOT NULL DEFAULT '',
  `user_name` varchar(32) NOT NULL DEFAULT '',
  `password` varchar(128) NOT NULL DEFAULT '',
  `login_type` int NOT NULL DEFAULT '0' COMMENT '手机号',
  `deleted` int NOT NULL DEFAULT '0' COMMENT '1删除 0正常',
  `user_role` int NOT NULL DEFAULT '0',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_name` (`user_name`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户基础信息表'

CREATE TABLE `user_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `user_name` varchar(50) NOT NULL DEFAULT '',
  `photo` varchar(128) NOT NULL DEFAULT '',
  `position` varchar(50) NOT NULL DEFAULT '',
  `company` varchar(50) NOT NULL DEFAULT '',
  `profile` varchar(225) NOT NULL DEFAULT '',
  `extend` varchar(1024) NOT NULL DEFAULT '',
  `ip` json DEFAULT NULL COMMENT '用户的ip信息',
  `deleted` tinyint NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `key_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户个人信息表'

CREATE TABLE `user_relation` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `follow_user_id` int unsigned NOT NULL,
  `follow_state` tinyint unsigned NOT NULL DEFAULT '0',
  `last_follow_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '用户最后关注（业务时间）',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_follow` (`user_id`,`follow_user_id`),
  KEY `key_follow_user_id` (`follow_user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=123 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户关系表'

CREATE TABLE `user_count` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `fan_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '粉丝数',
  `follow_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '关注数',
  `read_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被阅读总数',
  `comment_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被评论总数',
  `like_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被点赞总数',
  `collect_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '被收藏总数',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=580 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户综合计数表'
```



## 文章相关

### 5. article

文章表记录的是每个文章的基本信息

需要注意source_url默认应该为空。

| 字段名        | 数据类型         | 说明                         | 备注               |
| ------------- | ---------------- | ---------------------------- | ------------------ |
| id            | int(10) unsigned | 主键                         | 自增               |
| user\_id      | int(10) unsigned | 用户ID                       |                    |
| article\_type | tinyint(4)       | 文章类型：1-博文，2-问答     |                    |
| title         | varchar(120)     | 文章标题                     |                    |
| version       | int(11)          | 最新版本                     | 当前最新版本       |
| short\_title  | varchar(120)     | 短标题                       |                    |
| picture       | varchar(128)     | 文章头图                     |                    |
| summary       | varchar(300)     | 文章摘要                     |                    |
| category\_id  | int(10) unsigned | 类目ID                       |                    |
| source        | tinyint(4)       | 来源：1-转载，2-原创，3-翻译 |                    |
| source\_url   | varchar(128)     | 原文链接                     | 默认空             |
| offical\_stat | int(10) unsigned | 官方状态：0-非官方，1-官方   |                    |
| topping\_stat | int(10) unsigned | 置顶状态：0-不置顶，1-置顶   |                    |
| cream\_stat   | int(10) unsigned | 加精状态：0-不加精，1-加精   |                    |
| status        | tinyint(4)       | 状态：0-未发布，1-已发布     |                    |
| deleted       | tinyint(4)       | 是否删除                     |                    |
| create\_time  | timestamp        | 创建时间                     | 默认当前时间       |
| update\_time  | timestamp        | 最后更新时间                 | 默认当前时间并更新 |



```sql
CREATE TABLE `article` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '作者用户ID',
  `article_type` tinyint NOT NULL DEFAULT '1' COMMENT '1博文 2问答',
  `title` varchar(120) NOT NULL DEFAULT '' COMMENT '文章标题',
  `short_title` varchar(120) NOT NULL DEFAULT '' COMMENT '短标题',
  `picture` varchar(128) NOT NULL DEFAULT '' COMMENT '文章头图',
  `summary` varchar(300) NOT NULL DEFAULT '' COMMENT '文章摘要',
  `category_id` int unsigned NOT NULL DEFAULT '0' COMMENT '类目ID',
  `source` tinyint NOT NULL DEFAULT '1' COMMENT '1转载 2原创 3翻译',
  `source_url` varchar(128) NOT NULL DEFAULT '' COMMENT '原文链接',
  `offical_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0非官方 1官方',
  `topping_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0不加精 1加精',
  `cream_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0不置顶 1置顶',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_title` (`title`),
  KEY `idx_short_title` (`short_title`),
  KEY `idx_user_ct` (`user_id`,`create_time`),
  KEY `idx_top_ct` (`topping_stat`,`create_time`),
  KEY `idx_create_time` (`create_time`),
  FULLTEXT KEY `summary` (`summary`) /*!50100 WITH PARSER `ngram` */ 
) ENGINE=InnoDB AUTO_INCREMENT=10100 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章表'
```



### 6. article_detail

文章详情里面记录文章的详细信息和版本信息，这个主要针对的是上线后可能还需要编辑和修改。

| 字段名       | 数据类型         | 说明         | 备注               |
| ------------ | ---------------- | ------------ | ------------------ |
| id           | int(10) unsigned | 主键         | 自增               |
| article\_id  | int(10) unsigned | 文章ID       |                    |
| version      | int(10) unsigned | 所属版本     |                    |
| content      | longtext         | 文章内容     |                    |
| deleted      | tinyint(4)       | 是否删除     |                    |
| create\_time | timestamp        | 创建时间     | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间 | 默认当前时间并更新 |



```sql
CREATE TABLE `article_detail` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  `content` longtext COMMENT '文章内容',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_article_version` (`article_id`,`version`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章详情表'
```



### 7.category

文章类别表，主要记录文章所属类别，类别是一个大类，**下面可以有很多标签，一篇文章只能属于一个类别**。

| 字段名         | 数据类型         | 说明                     | 备注               |
| -------------- | ---------------- | ------------------------ | ------------------ |
| id             | int(10) unsigned | 主键                     | 自增               |
| category\_name | varchar(64)      | 类目名称                 |                    |
| status         | tinyint(4)       | 状态：0-未发布，1-已发布 |                    |
| rank           | tinyint(4)       | 排序                     |                    |
| deleted        | tinyint(4)       | 是否删除                 |                    |
| create\_time   | timestamp        | 创建时间                 | 默认当前时间       |
| update\_time   | timestamp        | 最后更新时间             | 默认当前时间并更新 |



```sql
CREATE TABLE `category` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `category_name` varchar(64) NOT NULL DEFAULT '' COMMENT '类目名称',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `rank` tinyint NOT NULL DEFAULT '0' COMMENT '排序',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='类目管理表'
```



### 8. tag

标签表，标签是一个小类，属于某个类别，一篇文章可以有多个标签，一个标签也可以对应多篇文章。

| 字段名       | 数据类型         | 说明                               | 备注               |
| ------------ | ---------------- | ---------------------------------- | ------------------ |
| id           | int(10) unsigned | 主键                               | 自增               |
| tag\_name    | varchar(120)     | 标签名称                           |                    |
| tag\_type    | tinyint(4)       | 标签类型：1-系统标签，2-自定义标签 |                    |
| category\_id | int(10) unsigned | 类目ID                             |                    |
| status       | tinyint(4)       | 状态：0-未发布，1-已发布           |                    |
| deleted      | tinyint(4)       | 是否删除                           |                    |
| create\_time | timestamp        | 创建时间                           | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间                       | 默认当前时间并更新 |



```sql
CREATE TABLE `tag` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tag_name` varchar(120) NOT NULL COMMENT '标签名称',
  `tag_type` tinyint NOT NULL DEFAULT '1' COMMENT '1系统标签 2自定义标签',
  `category_id` int unsigned NOT NULL DEFAULT '0' COMMENT '所属类目ID',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`)
) ENGINE=InnoDB AUTO_INCREMENT=98 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='标签管理表'
```



### 9. article_tag

关联标签表和文章表，一条记录表示某篇文章的某个标签。

| 字段名       | 数据类型         | 说明         | 备注               |
| ------------ | ---------------- | ------------ | ------------------ |
| id           | int(10) unsigned | 主键         | 自增               |
| article\_id  | int(10) unsigned | 文章ID       |                    |
| tag\_id      | int(11)          | 标签         |                    |
| deleted      | tinyint(4)       | 是否删除     |                    |
| version      | int(11)          | 所属版本     |                    |
| create\_time | timestamp        | 创建时间     | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间 | 默认当前时间并更新 |



```sql
CREATE TABLE `article_tag` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `tag_id` int NOT NULL DEFAULT '0' COMMENT '标签ID',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  PRIMARY KEY (`id`),
  KEY `idx_tag_id` (`tag_id`),
  KEY `idx_aid_ver_covered` (`article_id`,`version`,`tag_id`)
) ENGINE=InnoDB AUTO_INCREMENT=32789 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章标签映射表'
```



### 10. article_interation

记录用户针对文章的互动记录包括收藏、评价记录、点赞记录等等。

这里加入了打分和阅读时间统计等字段。

有了最后阅读时间就可以统计用户最近在读什么，可以给用户文章阅读的文章按照时间排序，可以给用户推送类似”关注的用户更新了，上次读是什么时候“之类的。

阅读时间暂时先不做，涉及到前端传值，目前交互逻辑尚不清楚（需要前端配合在离开界面的时候发送请求刷新时长，可能需要分开用点进时间和离开时间来记录）。

| 字段名            | 数据类型         | 说明                                     | 备注                       |
| ----------------- | ---------------- | ---------------------------------------- | -------------------------- |
| id                | int(10) unsigned | 主键ID                                   | 自增                       |
| user\_id          | int(10) unsigned | 用户ID                                   |                            |
| article\_id       | int(10) unsigned | 文章ID                                   | 可以为空但逻辑上不可以     |
| article\_user\_id | int(10) unsigned | 发布该文档的用户ID                       |                            |
| collection\_stat  | tinyint(3)       | 收藏状态: 0-未收藏，1-已收藏，2-取消收藏 |                            |
| read\_stat        | tinyint(3)       | 阅读状态: 0-未读，1-已读                 |                            |
| comment\_stat     | tinyint(3)       | 评论状态: 0-未评论，1-已评论，2-删除评论 |                            |
| like\_status      | tinyint(3)       | 点赞状态: 0-未点赞，1-已点赞，2-取消点赞 |                            |
| score             | tinyint(3)       | 用户打分: 1-5                            | NULL 表示未评分            |
| read\_duration    | int(10) unsigned | 阅读时长（秒）                           | 默认 0                     |
| first\_read\_time | datetime         | 首次阅读时间                             | 可空，只计算第一次点击时间 |
| last\_read\_time  | datetime         | 末次阅读时间                             | 可空，计算最后一次点击时间 |
| deleted           | tinyint(3)       | 0-正常，1-已删                           | 默认 0                     |
| create\_time      | timestamp        | 创建时间                                 | 默认当前时间               |
| update\_time      | timestamp        | 最后更新时间                             | 默认当前时间并更新         |



```sql
CREATE TABLE `article_interaction` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `article_user_id` int unsigned DEFAULT '0' COMMENT '发布该文章的用户ID',
  `collect_stat` tinyint NOT NULL DEFAULT '0' COMMENT '收藏状态：0-未收藏，1-已收藏，2-取消收藏',
  `read_stat` tinyint NOT NULL DEFAULT '0' COMMENT '阅读状态：0-未读，1-已读',
  `comment_stat` tinyint NOT NULL DEFAULT '0' COMMENT '评论状态：0-未评论，1-已评论，2-删除评论',
  `like_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点赞状态：0-未点赞，1-已点赞，2-取消点赞',
  `score` tinyint DEFAULT NULL COMMENT '用户打分：1-5',
  `read_duration` int unsigned NOT NULL DEFAULT '0' COMMENT '阅读时长（秒）',
  `first_read_time` datetime DEFAULT NULL COMMENT '首次阅读时间',
  `last_read_time` datetime DEFAULT NULL COMMENT '末次阅读时间',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '0-正常，1-已删',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_article` (`user_id`,`article_id`),
  KEY `idx_article_user` (`article_id`,`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=323 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户对文章互动足迹表'
```



### 11. article_count 

article_count主要存储一篇文章的阅读、点赞、收藏、评论等数量

| 字段名       | 数据类型         | 说明           | 备注               |
| ------------ | ---------------- | -------------- | ------------------ |
| id           | int(10) unsigned | 主键ID         | 自增               |
| article_id   | int(10) unsigned | 文档ID（文章） |                    |
| read_cnt     | int(10) unsigned | 访问计数       | 默认0              |
| like_cnt     | int(10) unsigned | 点赞计数       | 默认0              |
| collect_cnt  | int(10) unsigned | 收藏计数       | 默认0              |
| comment_cnt  | int(10) unsigned | 评论计数       | 默认0              |
| report_cnt   | int(10) unsigned | 举报计数       | 默认0              |
| create\_time | timestamp        | 创建时间       | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间   | 默认当前时间并更新 |



```mysql
CREATE TABLE `article_count` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL COMMENT '文章ID',
  `read_cnt` int unsigned NOT NULL DEFAULT '0',
  `like_cnt` int unsigned NOT NULL DEFAULT '0',
  `collect_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '收藏计数',
  `comment_cnt` int unsigned NOT NULL DEFAULT '0',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `report_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '举报数',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_article_id` (`article_id`)
) ENGINE=InnoDB AUTO_INCREMENT=330 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章统计计数表（自增）'
```





### 建表汇总

```sql
CREATE TABLE `article` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '作者用户ID',
  `article_type` tinyint NOT NULL DEFAULT '1' COMMENT '1博文 2问答',
  `title` varchar(120) NOT NULL DEFAULT '' COMMENT '文章标题',
  `short_title` varchar(120) NOT NULL DEFAULT '' COMMENT '短标题',
  `picture` varchar(128) NOT NULL DEFAULT '' COMMENT '文章头图',
  `summary` varchar(300) NOT NULL DEFAULT '' COMMENT '文章摘要',
  `category_id` int unsigned NOT NULL DEFAULT '0' COMMENT '类目ID',
  `source` tinyint NOT NULL DEFAULT '1' COMMENT '1转载 2原创 3翻译',
  `source_url` varchar(128) NOT NULL DEFAULT '' COMMENT '原文链接',
  `offical_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0非官方 1官方',
  `topping_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0不加精 1加精',
  `cream_stat` int unsigned NOT NULL DEFAULT '0' COMMENT '0不置顶 1置顶',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_title` (`title`),
  KEY `idx_short_title` (`short_title`),
  KEY `idx_user_ct` (`user_id`,`create_time`),
  KEY `idx_top_ct` (`topping_stat`,`create_time`),
  KEY `idx_create_time` (`create_time`),
  FULLTEXT KEY `summary` (`summary`) /*!50100 WITH PARSER `ngram` */ 
) ENGINE=InnoDB AUTO_INCREMENT=10100 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章表'

CREATE TABLE `article_detail` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  `content` longtext COMMENT '文章内容',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_article_version` (`article_id`,`version`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章详情表'

CREATE TABLE `category` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `category_name` varchar(64) NOT NULL DEFAULT '' COMMENT '类目名称',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `rank` tinyint NOT NULL DEFAULT '0' COMMENT '排序',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='类目管理表'

CREATE TABLE `tag` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tag_name` varchar(120) NOT NULL COMMENT '标签名称',
  `tag_type` tinyint NOT NULL DEFAULT '1' COMMENT '1系统标签 2自定义标签',
  `category_id` int unsigned NOT NULL DEFAULT '0' COMMENT '所属类目ID',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0未发布 1已发布',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`)
) ENGINE=InnoDB AUTO_INCREMENT=98 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='标签管理表'

CREATE TABLE `article_tag` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `tag_id` int NOT NULL DEFAULT '0' COMMENT '标签ID',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `version` int unsigned NOT NULL DEFAULT '1' COMMENT '版本号',
  PRIMARY KEY (`id`),
  KEY `idx_tag_id` (`tag_id`),
  KEY `idx_aid_ver_covered` (`article_id`,`version`,`tag_id`)
) ENGINE=InnoDB AUTO_INCREMENT=32789 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章标签映射表'

CREATE TABLE `article_count` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL COMMENT '文章ID',
  `read_cnt` int unsigned NOT NULL DEFAULT '0',
  `like_cnt` int unsigned NOT NULL DEFAULT '0',
  `collect_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '收藏计数',
  `comment_cnt` int unsigned NOT NULL DEFAULT '0',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `report_cnt` int unsigned NOT NULL DEFAULT '0' COMMENT '举报数',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_article_id` (`article_id`)
) ENGINE=InnoDB AUTO_INCREMENT=330 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文章统计计数表（自增）'

CREATE TABLE `article_interaction` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `article_user_id` int unsigned DEFAULT '0' COMMENT '发布该文章的用户ID',
  `collect_stat` tinyint NOT NULL DEFAULT '0' COMMENT '收藏状态：0-未收藏，1-已收藏，2-取消收藏',
  `read_stat` tinyint NOT NULL DEFAULT '0' COMMENT '阅读状态：0-未读，1-已读',
  `comment_stat` tinyint NOT NULL DEFAULT '0' COMMENT '评论状态：0-未评论，1-已评论，2-删除评论',
  `like_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点赞状态：0-未点赞，1-已点赞，2-取消点赞',
  `score` tinyint DEFAULT NULL COMMENT '用户打分：1-5',
  `read_duration` int unsigned NOT NULL DEFAULT '0' COMMENT '阅读时长（秒）',
  `first_read_time` datetime DEFAULT NULL COMMENT '首次阅读时间',
  `last_read_time` datetime DEFAULT NULL COMMENT '末次阅读时间',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '0-正常，1-已删',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_article` (`user_id`,`article_id`),
  KEY `idx_article_user` (`article_id`,`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=323 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户对文章互动足迹表'
```








## 评论相关

### 12. comment

评论存储了不同文章不同层级评论相关的信息，这里需要注意的就是评论不同层级的恢复。

主要存储一条评论本身的信息。

| 字段名              | 数据类型         | 说明         | 备注               |
| ------------------- | ---------------- | ------------ | ------------------ |
| id                  | int(10) unsigned | 主键ID       | 自增               |
| article\_id         | int(10) unsigned | 文章ID       |                    |
| user\_id            | int(10) unsigned | 用户ID       |                    |
| content             | varchar(300)     | 评论内容     |                    |
| top\_comment\_id    | int(11)          | 顶级评论ID   | 游标查询用不到 |
| parent\_comment\_id | int(10) unsigned | 父评论ID     |                 | deleted           | tinyint(3)       | 0-正常，1-已删                           | 默认 0             |
| create\_time        | timestamp        | 创建时间       | 默认当前时间         |
| update\_time        | timestamp        | 最后更新时间 | 默认当前时间并更新                     |

```sql
CREATE TABLE `comment` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `content` varchar(300) NOT NULL DEFAULT '' COMMENT '评论内容',
  `top_comment_id` int NOT NULL DEFAULT '0' COMMENT '顶级评论ID',
  `parent_comment_id` int unsigned NOT NULL DEFAULT '0' COMMENT '父评论ID',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '0-正常，1-已删',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='评论表'
```



### 13. comment_interaction

记录用户的评论交互信息，加入了点踩和举报后续可能扩展。

主要存储一个用户和一条评论产生的交互数据。

| 字段名            | 数据类型         | 说明                                     | 备注               |
| ----------------- | ---------------- | ---------------------------------------- | ------------------ |
| id                | int(10) unsigned | 主键ID                                   | 自增               |
| user\_id          | int(10) unsigned | 用户ID                                   |                    |
| comment\_id       | int(10) unsigned | 评论ID                                   |                    |
| comment\_user\_id | int(10) unsigned | 发布该评论的用户ID                       |                    |
| like\_status      | tinyint(3)       | 点赞状态: 0-未点赞，1-已点赞，2-取消点赞 | 默认0              |
| dislike\_status   | tinyint(3)       | 点踩状态: 0-无，1-已踩，2-取消           | 默认 0             |
| report_status     | tinyint(4)       | 点赞状态: 0-未举报，1-已举报             | 默认0              |
| create\_time      | timestamp        | 创建时间                                 | 默认当前时间       |
| update\_time      | timestamp        | 最后更新时间                             | 默认当前时间并更新 |

```sql
CREATE TABLE `comment_interaction` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `comment_id` int unsigned NOT NULL DEFAULT '0' COMMENT '评论ID',
  `like_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点赞状态：0-未点，1-已点，2-取消点赞',
  `dislike_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点踩状态：0-未点，1-已点，2-取消点踩',
  `report_stat` tinyint NOT NULL DEFAULT '0' COMMENT '举报状态：0-未举报，1-已举报',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_comment` (`user_id`,`comment_id`),
  KEY `idx_comment_user` (`comment_id`,`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户对评论互动足迹表'
```



### 14. comment_count

主要记录评论相关的计数，因为是高速读写为了减少锁表对评论表的影响因此独立读出来。

| 字段名       | 数据类型         | 说明         | 备注                                                 |
| ------------ | ---------------- | ------------ | ---------------------------------------------------- |
| id           | int(10) unsigned | 主键ID       | 自增                                                 |
| comment\_id  | int(10) unsigned | 评论ID       |                                                      |
| like\_cnt    | int(10) unsigned | 点赞数       | 默认 0                                               |
| dislike\_cnt | int(10) unsigned | 点踩数       | 默认 0                                               |
| report\_cnt  | int(10) unsigned | 举报数       | 默认 0                                               |
| reply_cnt    | int(10) unsigned | 回复数       | 默认 0                                               |
| update\_time | timestamp        | 最后更新时间 | 默认 CURRENT\_TIMESTAMP ON UPDATE CURRENT\_TIMESTAMP |



```sql
CREATE TABLE `comment_count` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `comment_id` int unsigned NOT NULL COMMENT '评论ID',
  `like_cnt` int NOT NULL DEFAULT '0',
  `dislike_cnt` int NOT NULL DEFAULT '0',
  `report_cnt` int NOT NULL DEFAULT '0',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `reply_cnt` int NOT NULL DEFAULT '0' COMMENT '总回复数',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_comment_id` (`comment_id`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='评论计数表（自增）'
```

### 建表汇总

```sql
CREATE TABLE `comment` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `article_id` int unsigned NOT NULL DEFAULT '0' COMMENT '文章ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `content` varchar(300) NOT NULL DEFAULT '' COMMENT '评论内容',
  `top_comment_id` int NOT NULL DEFAULT '0' COMMENT '顶级评论ID',
  `parent_comment_id` int unsigned NOT NULL DEFAULT '0' COMMENT '父评论ID',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '0-正常，1-已删',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='评论表'

CREATE TABLE `comment_interaction` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` int unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `comment_id` int unsigned NOT NULL DEFAULT '0' COMMENT '评论ID',
  `like_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点赞状态：0-未点，1-已点，2-取消点赞',
  `dislike_stat` tinyint NOT NULL DEFAULT '0' COMMENT '点踩状态：0-未点，1-已点，2-取消点踩',
  `report_stat` tinyint NOT NULL DEFAULT '0' COMMENT '举报状态：0-未举报，1-已举报',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_comment` (`user_id`,`comment_id`),
  KEY `idx_comment_user` (`comment_id`,`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户对评论互动足迹表'

CREATE TABLE `comment_count` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `comment_id` int unsigned NOT NULL COMMENT '评论ID',
  `like_cnt` int NOT NULL DEFAULT '0',
  `dislike_cnt` int NOT NULL DEFAULT '0',
  `report_cnt` int NOT NULL DEFAULT '0',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `reply_cnt` int NOT NULL DEFAULT '0' COMMENT '总回复数',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_comment_id` (`comment_id`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='评论计数表（自增）'
```






## 消息相关

消息包括六种：私信（系统通知、其他用户的私信）、回复（回复自己的评论）、点赞（评论、文章、专栏）、收藏（文章、专栏）、回复（别人回复你评论）、关注（关注自己）、评论（评论自己的文章、专栏）。

**约定**：

1. 系统通知相当于系统也是一个用户，给用户发一些消息。
2. 取消点赞、收藏、删除评论，都不发通知
3. 取关不发通知，关注消息发通知。
4. 表里面的deleted约定为用户是否删除通知。



### 15. notice_content

消息表，存储消息主体。

目前方案为没有联合主键（用户给同一个用户的点赞或者关注等信息会出现重复），目前有很多产品实际也是这样，比如抖音关注取关关注会有很多消息，不进行特别处理。

related_info表示关联消息预览，最长50字（中文编码，因为中文编码每个字4个字节），更长的会被截断（用于界面信息预览），truncated表示是否截断，如果截断需要根据id到其他表里面读更多详情内容。

区分deleted和status：状态位status和删除符deleted都表示消息有效性。**status表示发送者方主动失效，deleted表示接受者方主动失效（删除消息，后不再显示）**。status为false表示的是发送者取消关注、取消收藏、撤回私信、删除评论等，为true表示有效，而deleted为true表示接受者主动删除，这种消息不再显示在用户消息栏。（后续考虑因为取消关注、取消点赞、取消收藏不用通知，因此不用更新，只有删除评论和撤回私信需要追加，替换掉原来的通知）




| 字段名          | 数据类型        | 说明         | 备注                                |
| --------------- | --------------- | ------------ | ----------------------------------- |
| id              | bigint unsigned | 主键ID       | 自增                                |
| user_id         | bigint unsigned | 接收者用户ID | 索引(idx_user_type)                 |
| operate_user_id | bigint unsigned | 触发者用户ID |                                     |
| type            | tinyint(4)      | 通知类型     | 1私信 2回复 3评论 4点赞 5收藏 6关注 |
| target_type     | tinyint(4)      | 目标类型     | 1文章 2评论 3专栏                   |
| target_id       | bigint unsigned | 目标主键     | 信息索引(idx_target)                  |
| related_info    | varchar(200)    | 关联信息摘要 | utf8mb4,前50字                      |
| read_flag       | tinyint(1)     | 已读标记     | 默认0 未读                          |
| truncated         | tinyint(1)     | 是否截断     | 默认0 未截断                               |
| status | tinyint(1) | 状态位 | 默认1 有效 0 无效 |
| deleted         | tinyint(1)     | 逻辑删除     | 默认0 未删除                         |
| create_time     | timestamp       | 创建时间     | 默认当前时间                        |
| update_time     | timestamp       | 最后更新时间 | 默认当前时间并更新                  |

```sql
CREATE TABLE `notice_content` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL COMMENT '接收者',
  `operate_user_id` bigint unsigned NOT NULL COMMENT '触发者',
  `type` tinyint NOT NULL COMMENT '1私信 2回复 3评论 4点赞 5收藏 6关注',
  `target_type` tinyint NOT NULL COMMENT '1文章 2评论 3专栏',
  `target_id` bigint unsigned NOT NULL COMMENT '目标主键',
  `related_info` varchar(200) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '' COMMENT '列表摘要（写200字）',
  `read_flag` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未读 1已读',
  `truncated` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未截断 1已截断',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '0无效 1有效',
  `deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未删除 1已删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_type` (`user_id`,`type`,`create_time`),
  KEY `idx_target` (`target_type`,`target_id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='通知主体表'
```



### 16. notice_count

| 字段名         | 数据类型        | 说明         | 备注               |
| -------------- | --------------- | ------------ | ------------------ |
| id             | bigint unsigned | 主键ID       | 自增               |
| user_id        | bigint unsigned | 用户ID       | 唯一索引           |
| unread_private | int unsigned    | 未读私信数   | 默认0              |
| unread_reply   | int unsigned    | 未读回复数   | 默认0              |
| unread_comment | int unsigned    | 未读评论数   | 默认0              |
| unread_like    | int unsigned    | 未读点赞数   | 默认0              |
| unread_collect | int unsigned    | 未读收藏数   | 默认0              |
| unread_follow  | int unsigned    | 未读关注数   | 默认0              |
| create_time    | timestamp       | 创建时间     | 默认当前时间       |
| update_time    | timestamp       | 最后更新时间 | 默认当前时间并更新 |



```sql
CREATE TABLE `notice_count` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL,
  `unread_system` int NOT NULL DEFAULT '0',
  `unread_reply` int NOT NULL DEFAULT '0',
  `unread_comment` int NOT NULL DEFAULT '0',
  `unread_like` int NOT NULL DEFAULT '0',
  `unread_collect` int NOT NULL DEFAULT '0',
  `unread_follow` int NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='通知未读计数'
```



### 0. notice_pirvate（删除）

用户私信信息，如果通知信息被截断那么需要额外存储全部消息。

**后续考虑通知模块只显示预览，那么其实这一张表加上上面的截断都是没用的字段，因为永远只显示预览（有relatedInfo就够了）**

| 字段名        | 数据类型        | 说明         | 备注    |
| ------------- | --------------- | ------------ | ------- |
| id            | bigint unsigned | 主键         | 自增    |
| content       | text            | 私信完整原文 | utf8mb4 |
| created\_time | timestamp       | 记录创建时间 | 默认    |

后续该表被删除，为了保证上下文这里没有删掉。（因为在notice_content里面有截断标记，感觉也没什么用了）



### 建表汇总

```sql
CREATE TABLE `notice_content` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL COMMENT '接收者',
  `operate_user_id` bigint unsigned NOT NULL COMMENT '触发者',
  `type` tinyint NOT NULL COMMENT '1私信 2回复 3评论 4点赞 5收藏 6关注',
  `target_type` tinyint NOT NULL COMMENT '1文章 2评论 3专栏',
  `target_id` bigint unsigned NOT NULL COMMENT '目标主键',
  `related_info` varchar(200) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '' COMMENT '列表摘要（写200字）',
  `read_flag` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未读 1已读',
  `truncated` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未截断 1已截断',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '0无效 1有效',
  `deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0未删除 1已删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_type` (`user_id`,`type`,`create_time`),
  KEY `idx_target` (`target_type`,`target_id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='通知主体表'

CREATE TABLE `notice_count` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL,
  `unread_system` int NOT NULL DEFAULT '0',
  `unread_reply` int NOT NULL DEFAULT '0',
  `unread_comment` int NOT NULL DEFAULT '0',
  `unread_like` int NOT NULL DEFAULT '0',
  `unread_collect` int NOT NULL DEFAULT '0',
  `unread_follow` int NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='通知未读计数'
```



## 聊天相关

### 17. chat_user_session

用户会话表

user_id约定为用户自己

| 字段名        | 数据类型         | 说明                 | 备注                                           |
| ------------- | ---------------- | -------------------- | ---------------------------------------------- |
| id            | int(10) unsigned | 主键 ID              | 自增                                           |
| user_id       | int(10) unsigned | 当前用户 ID          | 关联用户表                                     |
| peer_id       | int(10) unsigned | 对方用户 ID          | 与 user_id 组成唯一会话对，联合唯一索引        |
| snapshot      | varchar(200)     | 消息快照             | utf8mb4,前50字                                 |
| last_msg_time | timestamp        | 最后一条消息发送时间 | 用于列表排序（最新时间在前）                   |
| unread_count  | int unsigned     | 未读消息数量         | 默认 0，超过 99 显示 “99+”                     |
| is_top        | tinyint unsigned | 是否置顶             | 0 - 不置顶 / 1 - 置顶，影响列表排序优先级      |
| is_mute       | tinyint unsigned | 是否关闭通知         | 0 - 接收通知 / 1 - 不接收通知                  |
| is_delete     | tinyint unsigned | 是否删除会话         | 0 - 正常 / 1 - 已删除（仅对当前 user_id 生效） |
| create_time   | timestamp        | 会话创建时间         | 默认当前时间，首次聊天时生成                   |
| update_time   | timestamp        | 会话最后更新时间     | 消息发送 / 状态变更时自动更新                  |

```sql
CREATE TABLE `chat_user_session` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `peer_id` int unsigned NOT NULL,
  `snapshot` varchar(200) NOT NULL DEFAULT '' COMMENT '最新消息前50字',
  `last_msg_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `unread_count` int unsigned NOT NULL DEFAULT '0',
  `is_top` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0不置顶 1置顶',
  `is_mute` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0接收通知 1关闭',
  `is_delete` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0正常 1已删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `display_seq` int unsigned NOT NULL DEFAULT '0' COMMENT '快照对应消息seq',
  `seq` int unsigned NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_peer` (`user_id`,`peer_id`),
  KEY `idx_user_time` (`user_id`,`is_top` DESC,`last_msg_time` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户会话表'
```



### 18. chat_user_history

主要存储用户的聊天记录

对话内游标可以方便后续可能有调顺序之类的需求（直接调seq），并且也方便游标获取数据（更多历史消息）。

| 字段名       | 数据类型         | 说明                               | 备注               |
| ------------ | ---------------- | ---------------------------------- | ------------------ |
| id           | int(10) unsigned | 主键ID                             | 自增               |
| seq          | int(10) unsigned | 对话内消息id                       | 默认1，多一条+1    |
| sender_id    | int(10) unsigned | 发送者id                           |                    |
| receiver_id  | int(10) unsigned | 接收者id                           |                    |
| content      | text             | 正文                               |                    |
| msg_type     | tinyint          | 0=文本 1=图片 2=文件 3=语音 4=视频 |                    |
| status       | tinyint          | 0=正常 1=发送者撤回 2=系统删除     | 默认0              |
| read_flag    | tinyint          | 0=未读 1=已读                      | 默认0              |
| deleted_by_s | tinyint          | 0=正常 1=发送方删除                | 默认0              |
| deleted_by_r | tinyint          | 0=正常 1=接收方删除                | 默认0              |
| create\_time | timestamp        | 创建时间                           | 默认当前时间       |
| update\_time | timestamp        | 最后更新时间                       | 默认当前时间并更新 |

```sql
CREATE TABLE `chat_user_history` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `seq` int unsigned NOT NULL DEFAULT '1' COMMENT '对话内消息序号',
  `sender_id` int unsigned NOT NULL,
  `receiver_id` int unsigned NOT NULL,
  `content` text NOT NULL,
  `msg_type` tinyint NOT NULL DEFAULT '0' COMMENT '0文本 1图片 2文件 3语音 4视频',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1发送者撤回 2系统删除',
  `read_flag` tinyint NOT NULL DEFAULT '0' COMMENT '0未读 1已读',
  `deleted_by_s` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1发送方删除',
  `deleted_by_r` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1接收方删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_sender_seq` (`sender_id`,`seq`),
  KEY `idx_receiver_seq` (`receiver_id`,`seq`),
  KEY `idx_dialog` ((least(`sender_id`,`receiver_id`)),(greatest(`sender_id`,`receiver_id`)),`seq` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户聊天记录'
```



### 19. chat_ai_session

用户ai会话信息。

点击LLM，前端要请求用户有哪些对话，先查询这里，然后再根据返回的用户历史会话先渲染出列表，然后用户点击某个session前端用session_id来请求

这个id自增，只有在seq为1的时候创建，因为只有发送消息之后才会建立新会话。所以只是点击新建会话，那么是不会创建的。

> 本来想改成雪花id保证一点击新建会话就创建记录，但是想想如果用户都没发消息那么这个会话是没意义的，只有第一条信息被发送了再建才有意义。

新建会话不会太频繁，甚至不需要用reids异步落库来维护，建立一次插入一次就可以了。（增删改查直接访问数据库就可以）

最后更新时间和seq随AI聊天内容模块异步落库

| 字段名        | 数据类型          | 说明                 | 备注                         |
| ------------- | ----------------- | -------------------- | ---------------------------- |
| id            | int (10) unsigned | 自增                 | 非空                         |
| user\_id      | int (10) unsigned | 用户id               | 默认 0                       |
| title         | varchar(120)      | 会话标题             | 默认                         |
| deleted       | tinyint           | 是否删除             | 默认 0                       |
| seq           | int(10) unsigned  | 最后一条seq          | 默认1，多一条+1              |
| last_msg_time | timestamp         | 最后一条消息发送时间 | 用于列表排序（最新时间在前） |
| create\_time  | timestamp         | 创建时间             | 默认当前时间                 |
| update\_time  | timestamp         | 最后更新时间         | 默认当前时间并更新           |

```sql
CREATE TABLE `chat_ai_session` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `title` varchar(120) NOT NULL DEFAULT '新会话',
  `deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `seq` int unsigned NOT NULL DEFAULT '1',
  `last_msg_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_time` (`user_id`,`update_time` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='AI 会话汇总'
```





### 20. chat_ai_history

主要存储用户使用ai的记录。

session_id表示一整次聊天的标记，方便拉取历史记录。

parent_id可以方便后续把用户和AI的多轮聊天拼起来给模型，获得更好的效果。（把最近几条消息拼起来）

| 字段名       | 数据类型          | 说明                                                | 备注               |
| ------------ | ----------------- | --------------------------------------------------- | ------------------ |
| id           | int (10) unsigned | 主键ID                                              | 自增               |
| session_id   | int (10) unsigned | 会话id                                              | 非空               |
| seq          | int(10) unsigned  | 对话内消息seq                                       | 默认1，多一条+1    |
| user\_id     | int (10) unsigned | 用户id                                              | 默认 0             |
| sender       | tinyint           | 0=用户 1=AI                                         | 非空               |
| ai\_type     | tinyint           | 使用的AI类型 0=ccLLM 1=chatgpt3.5 2=chatgpt4 3=讯飞 | 默认 0             |
| content      | text              | 消息内容                                            | 非空               |
| deleted      | tinyint           | 是否删除                                            | 默认 0             |
| create\_time | timestamp         | 创建时间                                            | 默认当前时间       |
| update\_time | timestamp         | 最后更新时间                                        | 默认当前时间并更新 |

```sql
CREATE TABLE `chat_ai_history` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `session_id` int unsigned NOT NULL,
  `seq` int unsigned NOT NULL DEFAULT '1',
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `sender` tinyint NOT NULL COMMENT '0用户 1AI',
  `ai_type` tinyint NOT NULL DEFAULT '0' COMMENT '0ccLLM 1chatgpt3.5 2chatgpt4 3讯飞',
  `content` text NOT NULL,
  `deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `token` int unsigned NOT NULL DEFAULT '0' COMMENT '消耗token',
  `finish_reason` tinyint NOT NULL DEFAULT '0' COMMENT '0:正常 1:用户中止 2:其他异常',
  PRIMARY KEY (`id`),
  KEY `idx_session_seq` (`session_id`,`seq`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='AI 聊天记录'
```

### 建表汇总

```sql
CREATE TABLE `chat_user_session` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `peer_id` int unsigned NOT NULL,
  `snapshot` varchar(200) NOT NULL DEFAULT '' COMMENT '最新消息前50字',
  `last_msg_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `unread_count` int unsigned NOT NULL DEFAULT '0',
  `is_top` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0不置顶 1置顶',
  `is_mute` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0接收通知 1关闭',
  `is_delete` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0正常 1已删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `display_seq` int unsigned NOT NULL DEFAULT '0' COMMENT '快照对应消息seq',
  `seq` int unsigned NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_peer` (`user_id`,`peer_id`),
  KEY `idx_user_time` (`user_id`,`is_top` DESC,`last_msg_time` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户会话表'

CREATE TABLE `chat_user_history` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `seq` int unsigned NOT NULL DEFAULT '1' COMMENT '对话内消息序号',
  `sender_id` int unsigned NOT NULL,
  `receiver_id` int unsigned NOT NULL,
  `content` text NOT NULL,
  `msg_type` tinyint NOT NULL DEFAULT '0' COMMENT '0文本 1图片 2文件 3语音 4视频',
  `status` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1发送者撤回 2系统删除',
  `read_flag` tinyint NOT NULL DEFAULT '0' COMMENT '0未读 1已读',
  `deleted_by_s` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1发送方删除',
  `deleted_by_r` tinyint NOT NULL DEFAULT '0' COMMENT '0正常 1接收方删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_sender_seq` (`sender_id`,`seq`),
  KEY `idx_receiver_seq` (`receiver_id`,`seq`),
  KEY `idx_dialog` ((least(`sender_id`,`receiver_id`)),(greatest(`sender_id`,`receiver_id`)),`seq` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户聊天记录'

CREATE TABLE `chat_ai_session` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int unsigned NOT NULL,
  `title` varchar(120) NOT NULL DEFAULT '新会话',
  `deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `seq` int unsigned NOT NULL DEFAULT '1',
  `last_msg_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_time` (`user_id`,`update_time` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='AI 会话汇总'

CREATE TABLE `chat_ai_history` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `session_id` int unsigned NOT NULL,
  `seq` int unsigned NOT NULL DEFAULT '1',
  `user_id` int unsigned NOT NULL DEFAULT '0',
  `sender` tinyint NOT NULL COMMENT '0用户 1AI',
  `ai_type` tinyint NOT NULL DEFAULT '0' COMMENT '0ccLLM 1chatgpt3.5 2chatgpt4 3讯飞',
  `content` text NOT NULL,
  `deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `token` int unsigned NOT NULL DEFAULT '0' COMMENT '消耗token',
  `finish_reason` tinyint NOT NULL DEFAULT '0' COMMENT '0:正常 1:用户中止 2:其他异常',
  PRIMARY KEY (`id`),
  KEY `idx_session_seq` (`session_id`,`seq`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='AI 聊天记录'
```



## 通用

###  report_type

举报类别表

举报类别表记录举报类型的基本信息

其中target_mask记录了适用类型，对应于二进制的不同位，比如一个理由可以同时用作文章和评论，那么mask=1+2=3，因此如果查询评论类型，直接&2可以得到评论的相关条目

| 字段名       | 数据类型         | 说明                                    | 备注               |
| ------------ | ---------------- | --------------------------------------- | ------------------ |
| id           | int(10) unsigned | 主键ID                                  | 自增               |
| reason       | varchar(32)      | 举报                                    | 非空               |
| target\_mask | int unsigned     | 适用对象掩码，权值表：1文章 2评论 4用户 | 非空               |
| weight       | int(10)          | 排序权重 越小越靠前                     | 默认 0             |
| enabled      | tinyint          | 是否启用 0=禁用 1=启用                  | 默认 1             |
| create\_time | timestamp        | 创建时间                                | 默认当前时间       |
| update\_time | timestamp        | 更新时间                                | 默认当前时间并更新 |



###  report_record 

举报信息汇总表

| 字段名         | 数据类型         | 说明                        | 备注               |
| -------------- | ---------------- | --------------------------- | ------------------ |
| id             | bigint unsigned  | 主键ID                      | 自增               |
| reporter\_uid  | int(10) unsigned | 举报人用户ID                | 非空 索引          |
| target\_type   | tinyint(4)       | 被举报对象类型              | 非空               |
| target\_id     | bigint unsigned  | 被举报对象主键ID            | 非空               |
| reason\_id     | int(10) unsigned | 举报类型ID → report_type.id | 非空               |
| reason\_text   | text             | 补充文字                    | 可空               |
| proof\_urls    | json             | 证据图片路径地址            | 可空               |
| status         | tinyint          | 处理状态 0未处理 1已处理    | 默认0              |
| result\_action | varchar(32)      | 处理结果 0忽略  1接受 2拒绝 | 可空               |
| result\_note   | varchar(255)     | 管理员备注                  | 可空               |
| auditor\_id    | int(10) unsigned | 处理管理员ID                | 可空               |
| create\_time   | timestamp        | 举报时间                    | 默认当前时间       |
| update\_time   | timestamp        | 更新时间                    | 默认当前时间并更新 |



## flyway

本项目采用flyway来管理数据库，命名规则为：

```bash
V1.2.1__db.sql # 意为版本1.2.1,注意是双下划线__
```

**flyway在执行的时候只要版本号大于执行的最大的版本就会执行**。
