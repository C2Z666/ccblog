import{L as he,M as We,d as je,u as Ae,r as O,ae as _e,w as Ve,a1 as Be,a9 as Z,ab as He,c as P,a as F,g as J,t as Q,F as de,i as $e,H as ze,b0 as Ne,p as Ge,b1 as Ke,b2 as Je,j as Xe,$ as Ye,l as ie,bm as Ze,bn as Qe,bo as et,bp as tt,bq as nt,br as ot,o as D,O as ke,y as st,b6 as rt,bs as at,bt as it,D as ut,E as lt,_ as ct}from"./index-BDNZz3x8.js";var ue={exports:{}},be={};(function(v){(function(){var w,H,j,g,$={}.hasOwnProperty,d=[].slice;w={LF:`
`,NULL:"\0"},j=function(){var i;function n(e,t,o){this.command=e,this.headers=t??{},this.body=o??""}return n.prototype.toString=function(){var e,t,o,s,r;e=[this.command],o=this.headers["content-length"]===!1,o&&delete this.headers["content-length"],r=this.headers;for(t in r)$.call(r,t)&&(s=r[t],e.push(""+t+":"+s));return this.body&&!o&&e.push("content-length:"+n.sizeOfUTF8(this.body)),e.push(w.LF+this.body),e.join(w.LF)},n.sizeOfUTF8=function(e){return e?encodeURI(e).match(/%..|./g).length:0},i=function(e){var t,o,s,r,h,T,I,M,E,b,L,V,l,c,A,W,m;for(r=e.search(RegExp(""+w.LF+w.LF)),h=e.substring(0,r).split(w.LF),s=h.shift(),T={},V=function(q){return q.replace(/^\s+|\s+$/g,"")},W=h.reverse(),l=0,A=W.length;l<A;l++)b=W[l],M=b.indexOf(":"),T[V(b.substring(0,M))]=V(b.substring(M+1));if(t="",L=r+2,T["content-length"])E=parseInt(T["content-length"]),t=(""+e).substring(L,L+E);else for(o=null,I=c=L,m=e.length;(L<=m?c<m:c>m)&&(o=e.charAt(I),o!==w.NULL);I=L<=m?++c:--c)t+=o;return new n(s,T,t)},n.unmarshall=function(e){var t;return function(){var o,s,r,h;for(r=e.split(RegExp(""+w.NULL+w.LF+"*")),h=[],o=0,s=r.length;o<s;o++)t=r[o],(t!=null?t.length:void 0)>0&&h.push(i(t));return h}()},n.marshall=function(e,t,o){var s;return s=new n(e,t,o),s.toString()+w.NULL},n}(),H=function(){var i;function n(e){this.ws=e,this.ws.binaryType="arraybuffer",this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16*1024,this.subscriptions={}}return n.prototype.debug=function(e){var t;return typeof window<"u"&&window!==null&&(t=window.console)!=null?t.log(e):void 0},i=function(){return Date.now?Date.now():new Date().valueOf},n.prototype._transmit=function(e,t,o){var s;for(s=j.marshall(e,t,o),typeof this.debug=="function"&&this.debug(">>> "+s);;)if(s.length>this.maxWebSocketFrameSize)this.ws.send(s.substring(0,this.maxWebSocketFrameSize)),s=s.substring(this.maxWebSocketFrameSize),typeof this.debug=="function"&&this.debug("remaining = "+s.length);else return this.ws.send(s)},n.prototype._setupHeartbeat=function(e){var t,o,s,r,h,T;if(!((h=e.version)!==g.VERSIONS.V1_1&&h!==g.VERSIONS.V1_2)&&(T=function(){var I,M,E,b;for(E=e["heart-beat"].split(","),b=[],I=0,M=E.length;I<M;I++)r=E[I],b.push(parseInt(r));return b}(),o=T[0],t=T[1],this.heartbeat.outgoing===0||t===0||(s=Math.max(this.heartbeat.outgoing,t),typeof this.debug=="function"&&this.debug("send PING every "+s+"ms"),this.pinger=g.setInterval(s,function(I){return function(){return I.ws.send(w.LF),typeof I.debug=="function"?I.debug(">>> PING"):void 0}}(this))),!(this.heartbeat.incoming===0||o===0)))return s=Math.max(this.heartbeat.incoming,o),typeof this.debug=="function"&&this.debug("check PONG every "+s+"ms"),this.ponger=g.setInterval(s,function(I){return function(){var M;if(M=i()-I.serverActivity,M>s*2)return typeof I.debug=="function"&&I.debug("did not receive server activity for the last "+M+"ms"),I.ws.close()}}(this))},n.prototype._parseConnect=function(){var e,t,o,s;switch(e=1<=arguments.length?d.call(arguments,0):[],s={},e.length){case 2:s=e[0],t=e[1];break;case 3:e[1]instanceof Function?(s=e[0],t=e[1],o=e[2]):(s.login=e[0],s.passcode=e[1],t=e[2]);break;case 4:s.login=e[0],s.passcode=e[1],t=e[2],o=e[3];break;default:s.login=e[0],s.passcode=e[1],t=e[2],o=e[3],s.host=e[4]}return[s,t,o]},n.prototype.connect=function(){var e,t,o,s;return e=1<=arguments.length?d.call(arguments,0):[],s=this._parseConnect.apply(this,e),o=s[0],this.connectCallback=s[1],t=s[2],typeof this.debug=="function"&&this.debug("Opening Web Socket..."),this.ws.onmessage=function(r){return function(h){var T,I,M,E,b,L,V,l,c,A,W,m;if(E=typeof ArrayBuffer<"u"&&h.data instanceof ArrayBuffer?(T=new Uint8Array(h.data),typeof r.debug=="function"&&r.debug("--- got data length: "+T.length),function(){var q,ne,K;for(K=[],q=0,ne=T.length;q<ne;q++)I=T[q],K.push(String.fromCharCode(I));return K}().join("")):h.data,r.serverActivity=i(),E===w.LF){typeof r.debug=="function"&&r.debug("<<< PONG");return}for(typeof r.debug=="function"&&r.debug("<<< "+E),W=j.unmarshall(E),m=[],c=0,A=W.length;c<A;c++)switch(b=W[c],b.command){case"CONNECTED":typeof r.debug=="function"&&r.debug("connected to server "+b.headers.server),r.connected=!0,r._setupHeartbeat(b.headers),m.push(typeof r.connectCallback=="function"?r.connectCallback(b):void 0);break;case"MESSAGE":l=b.headers.subscription,V=r.subscriptions[l]||r.onreceive,V?(M=r,L=b.headers["message-id"],b.ack=function(q){return q==null&&(q={}),M.ack(L,l,q)},b.nack=function(q){return q==null&&(q={}),M.nack(L,l,q)},m.push(V(b))):m.push(typeof r.debug=="function"?r.debug("Unhandled received MESSAGE: "+b):void 0);break;case"RECEIPT":m.push(typeof r.onreceipt=="function"?r.onreceipt(b):void 0);break;case"ERROR":m.push(typeof t=="function"?t(b):void 0);break;default:m.push(typeof r.debug=="function"?r.debug("Unhandled frame: "+b):void 0)}return m}}(this),this.ws.onclose=function(r){return function(){var h;return h="Whoops! Lost connection to "+r.ws.url,typeof r.debug=="function"&&r.debug(h),r._cleanUp(),typeof t=="function"?t(h):void 0}}(this),this.ws.onopen=function(r){return function(){return typeof r.debug=="function"&&r.debug("Web Socket Opened..."),o["accept-version"]=g.VERSIONS.supportedVersions(),o["heart-beat"]=[r.heartbeat.outgoing,r.heartbeat.incoming].join(","),r._transmit("CONNECT",o)}}(this)},n.prototype.disconnect=function(e,t){return t==null&&(t={}),this._transmit("DISCONNECT",t),this.ws.onclose=null,this.ws.close(),this._cleanUp(),typeof e=="function"?e():void 0},n.prototype._cleanUp=function(){if(this.connected=!1,this.pinger&&g.clearInterval(this.pinger),this.ponger)return g.clearInterval(this.ponger)},n.prototype.send=function(e,t,o){return t==null&&(t={}),o==null&&(o=""),t.destination=e,this._transmit("SEND",t,o)},n.prototype.subscribe=function(e,t,o){var s;return o==null&&(o={}),o.id||(o.id="sub-"+this.counter++),o.destination=e,this.subscriptions[o.id]=t,this._transmit("SUBSCRIBE",o),s=this,{id:o.id,unsubscribe:function(){return s.unsubscribe(o.id)}}},n.prototype.unsubscribe=function(e){return delete this.subscriptions[e],this._transmit("UNSUBSCRIBE",{id:e})},n.prototype.begin=function(e){var t,o;return o=e||"tx-"+this.counter++,this._transmit("BEGIN",{transaction:o}),t=this,{id:o,commit:function(){return t.commit(o)},abort:function(){return t.abort(o)}}},n.prototype.commit=function(e){return this._transmit("COMMIT",{transaction:e})},n.prototype.abort=function(e){return this._transmit("ABORT",{transaction:e})},n.prototype.ack=function(e,t,o){return o==null&&(o={}),o["message-id"]=e,o.subscription=t,this._transmit("ACK",o)},n.prototype.nack=function(e,t,o){return o==null&&(o={}),o["message-id"]=e,o.subscription=t,this._transmit("NACK",o)},n}(),g={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(i,n){var e,t;return n==null&&(n=["v10.stomp","v11.stomp"]),e=g.WebSocketClass||WebSocket,t=new e(i,n),new H(t)},over:function(i){return new H(i)},Frame:j},v!==null&&(v.Stomp=g),typeof window<"u"&&window!==null?(g.setInterval=function(i,n){return window.setInterval(n,i)},g.clearInterval=function(i){return window.clearInterval(i)},window.Stomp=g):v||(self.Stomp=g)}).call(he)})(be);var me={},Ce={},xe;function qe(){if(xe)return Ce;xe=1;var v=qe();for(k in v)he[k]=v[k];return Ce}var pe,Te;function ft(){if(Te)return pe;Te=1;var v=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};return pe=function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return v()}try{return __global__||v()}finally{delete Object.prototype.__global__}}(),pe}const dt="websocket",pt="Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",vt=["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],gt="Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",mt=["Iñaki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],ht="1.0.35",bt={type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},yt="https://github.com/theturtle32/WebSocket-Node",wt={node:">=4.0.0"},It={bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},St={"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},_t={verbose:!1},Nt={test:"tape test/unit/*.js",gulp:"gulp"},kt="index",Ct={lib:"./lib"},xt="lib/browser.js",Tt="Apache-2.0",Ut={name:dt,description:pt,keywords:vt,author:gt,contributors:mt,version:ht,repository:bt,homepage:yt,engines:wt,dependencies:It,devDependencies:St,config:_t,scripts:Nt,main:kt,directories:Ct,browser:xt,license:Tt};var ve,Ue;function Mt(){return Ue||(Ue=1,ve=Ut.version),ve}var ge,Me;function qt(){if(Me)return ge;Me=1;var v;if(typeof globalThis=="object")v=globalThis;else try{v=ft()}catch{}finally{if(!v&&typeof window<"u"&&(v=window),!v)throw new Error("Could not determine global this")}var w=v.WebSocket||v.MozWebSocket,H=Mt();function j(g,$){var d;return $?d=new w(g,$):d=new w(g),d}return w&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(g){Object.defineProperty(j,g,{get:function(){return w[g]}})}),ge={w3cwebsocket:w?j:null,version:H},ge}(function(){var v,w,H,j,g,$;v=be,w=qe(),v.Stomp.setInterval=function(d,i){return setInterval(i,d)},v.Stomp.clearInterval=function(d){return clearInterval(d)},g=function(d,i){var n,e;return n=null,e={url:"tcp:// "+i+":"+d,send:function(t){return n.write(t)},close:function(){return n.end()}},n=w.connect(d,i,function(t){return e.onopen()}),n.on("error",function(t){return typeof e.onclose=="function"?e.onclose(t):void 0}),n.on("close",function(t){return typeof e.onclose=="function"?e.onclose(t):void 0}),n.on("data",function(t){var o;return o={data:t.toString()},e.onmessage(o)}),e},$=function(d){var i,n,e,t;return i=qt().client,n=null,t={url:d,send:function(o){return n.sendUTF(o)},close:function(){return n.close()}},e=new i,e.on("connect",function(o){return n=o,t.onopen(),n.on("error",function(s){return typeof t.onclose=="function"?t.onclose(s):void 0}),n.on("close",function(){return typeof t.onclose=="function"?t.onclose():void 0}),n.on("message",function(s){var r;if(s.type==="utf8")return r={data:s.utf8Data},t.onmessage(r)})}),e.connect(d),t},H=function(d,i){var n;return n=g(i,d),v.Stomp.over(n)},j=function(d){var i;return i=$(d),v.Stomp.over(i)},me.overTCP=H,me.overWS=j}).call(he);var Et=be,Ee=me;ue.exports=Et.Stomp;ue.exports.overTCP=Ee.overTCP;ue.exports.overWS=Ee.overWS;var Rt=ue.exports;const Lt=We(Rt),Ot=v=>(ut("data-v-f69c095a"),v=v(),lt(),v),Ft={class:"chat-container",style:{display:"flex","flex-direction":"column",height:"100%",position:"relative",overflow:"hidden"}},Pt={class:"chat-header"},Dt={class:"chat-user-info"},Wt=["src"],jt={class:"user-name"},At={class:"message-container",style:{flex:"1",overflow:"hidden",display:"flex","flex-direction":"column"}},Vt={key:0,class:"load-more-button-container"},Bt=["disabled"],Ht={key:1,class:"loading"},$t={key:2,class:"empty-message"},zt=["onContextmenu"],Gt=["src"],Kt={class:"message-content"},Jt=Ot(()=>F("div",{class:"recalled-icon"},"✓",-1)),Xt={class:"recalled-text"},Yt={class:"message-time"},Zt=["src"],Qt={class:"chat-input-area",style:{position:"absolute",bottom:"0",left:"0",right:"0",padding:"10px","background-color":"#fff","border-top":"1px solid #e0e0e0","z-index":"10"}},en=["disabled"],tn=["disabled"],nn=5,on=je({__name:"ChatUserView",props:{peerId:{}},emits:["update-session-preview","updateChatPreview"],setup(v,{emit:w}){const H=Xe(),j=Ye(),g=Ae(),$=v,d=w,i=O([]),n=O(null),e=O(""),t=O(!1),o=O(!1),s=O(),r=O(!0),h=O("等待连接"),T=O(!1),I=O(void 0),M=O(void 0),E=O(!1);let b=0;const L=O(!1),V=O({x:0,y:0}),l=O(null);let c=null,A=null,W="";const m=_e(()=>{var u,y;const a=(y=(u=g.global)==null?void 0:u.user)==null?void 0:y.userId;return typeof a=="string"?parseInt(a):a||0}),q=a=>{a&&H.push({path:`/user/${a}/articlesTab`})};function ne(a,u){V.value={x:a.clientX,y:a.clientY},l.value=u,L.value=!0}function K(){L.value=!1,l.value=null}function ye(a){d("updateChatPreview",{peerId:S.value,lastMsgTime:a.lastMsgTime,snapshot:a.snapshot})}async function Re(){var a,u;if(l.value)try{const y={seq:l.value.seq||0,recvUserId:Number(l.value.recvUserId),sendUserId:Number(l.value.sendUserId),type:l.value.type||0,content:l.value.content||"",readFlag:l.value.readFlag||!1,status:l.value.status||0,createTime:l.value.createTime};console.log("删除消息参数:",y);const f=await rt(at,y);if(f&&f.status===200&&f.data){f.data.result&&ye(f.data.result);const _=i.value.findIndex(B=>B.seq===l.value.seq);_>-1&&i.value.splice(_,1),f.data.result&&d("update-session-preview",{peerId:S.value,preview:f.data.result.snapshot||"",time:f.data.result.lastMsgTime,userName:(a=n.value)==null?void 0:a.peerInfo.userName,userPhoto:(u=n.value)==null?void 0:u.peerInfo.photo})}}catch(y){console.error("删除请求异常:",y)}finally{K()}else K()}async function Le(){var a,u,y,f,_,B;if(l.value&&Number(l.value.sendUserId)===Number(m.value))try{const z={seq:l.value.seq||0,recvUserId:Number(l.value.recvUserId),sendUserId:Number(l.value.sendUserId),type:l.value.type||0,content:l.value.content||"",readFlag:l.value.readFlag||!1,status:l.value.status||0,createTime:l.value.createTime||""},R=await ie(Ze,z);if(R&&R.status===200&&R.data){R.data.result&&ye(R.data.result);const G=i.value.findIndex(N=>N.seq===l.value.seq);if(G>-1){const N={...l.value,content:"你撤回了一条消息",status:1,originalContent:l.value.content};i.value.splice(G,1,N),G===i.value.length-1?d("update-session-preview",{peerId:S.value,preview:N.content,time:N.createTime||R.data.result.lastMsgTime,userName:(a=n.value)==null?void 0:a.peerInfo.userName,userPhoto:(u=n.value)==null?void 0:u.peerInfo.photo}):d("update-session-preview",{peerId:S.value,preview:R.data.result.snapshot||"",time:R.data.result.lastMsgTime,userName:(y=n.value)==null?void 0:y.peerInfo.userName,userPhoto:(f=n.value)==null?void 0:f.peerInfo.photo})}else d("update-session-preview",{peerId:S.value,preview:R.data.result.snapshot||"",time:R.data.result.lastMsgTime,userName:(_=n.value)==null?void 0:_.peerInfo.userName,userPhoto:(B=n.value)==null?void 0:B.peerInfo.photo})}else console.error("撤回失败:",R)}catch(z){console.error("撤回请求异常:",z)}finally{K()}}const S=_e(()=>$.peerId!==void 0?$.peerId:Number(j.params.peerId)||0);Ve(S,async(a,u)=>{a!==u&&(T.value=!1),a&&a!==0&&((!c||!c.connected)&&se(),await Promise.all([le(),we()]),await Z(),re())},{immediate:!0});const Oe=a=>{if(!a.createTime)return!1;const u=new Date(a.createTime);return(new Date().getTime()-u.getTime())/(1e3*60)<=2&&a.status!==1},oe=a=>{const u=new Date(a),f=new Date().getTime()-u.getTime(),_=Math.floor(f/(1e3*60*60*24));return _===0?u.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):_===1?"昨天 "+u.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):_<7?"周"+["日","一","二","三","四","五","六"][u.getDay()]+" "+u.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):u.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})+" "+u.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},le=async(a=!1)=>{if(S.value){a?E.value=!0:(t.value=!0,o.value=!1);try{const u={peerId:S.value,limit:nn};(a||I.value||M.value!==999999999)&&(u.cursor=I.value,u.cursorSeq=M.value);const y=await ie(Qe,u);if(y.data.result){const f=y.data.result.chatUserItems||[];if(f.length>0){const _=f[f.length-1];_.createTime&&(I.value=_.createTime),_.seq&&(M.value=_.seq)}a?i.value=[...f.reverse(),...i.value]:(b=f[0].seq||0,i.value=f.reverse()),T.value=y.data.result.hasMore||!1}}catch(u){console.error("获取聊天历史失败:",u),a||(o.value=!0)}finally{a?E.value=!1:t.value=!1}}},we=async()=>{if(S.value)try{const a=await ie(et,{peerId:S.value});a.data.result&&(n.value=a.data.result,g.setGlobal(a.data.global))}catch(a){console.error("获取聊天用户信息失败:",a)}},se=async()=>{try{const a=await ie(tt,{});if(a&&a.data&&a.data.result)W=a.data.result;else{console.error("获取ticket失败:",a);return}const u=`${nt}${ot}/chat/${W}`,y=new WebSocket(u);c=Lt.over(y),c.debug=f=>{},c.heartbeat.outgoing=2e4,c.heartbeat.incoming=2e4,c.connectHeaders={"heart-beat":"20000,20000",ticket:W},c.connect(c.connectHeaders,function(f){console.log("成功连接到STOMP服务器:",f),r.value=!1,h.value="发送",Pe(),c.subscribe(`/user/${m.value}/chat/user`,function(_){var B,z,R,G,N,X;console.log("收到私信/回执:",_.body);try{const p=JSON.parse(_.body);if(typeof p=="object"&&p!==null)if(p.type==="receipt"&&p.seq!==void 0){const C=p.seq,U=i.value.findLastIndex(x=>x.seq===0&&Number(x.sendUserId)===Number(m.value));if(U>-1){const x={...i.value[U],seq:C};i.value.splice(U,1,x),console.log("已更新本地消息的seq值:",C)}}else if(p.type==="recall"&&p.seq!==void 0){const C=p.seq,U=i.value.findIndex(x=>x.seq===C);if(U>-1){const x=i.value[U],ae=Number(x.sendUserId)===Number(m.value),Y={...x,status:1,content:ae?"您撤回了一条消息":"对方撤回了一条消息"};i.value.splice(U,1,Y),U===i.value.length-1&&d("update-session-preview",{peerId:S.value,preview:Y.content,time:Y.createTime||oe(new Date().toISOString()),userName:(B=n.value)==null?void 0:B.peerInfo.userName,userPhoto:(z=n.value)==null?void 0:z.peerInfo.photo})}}else if(p.type==="msg"&&p.data){const C=p.data;C.content&&C.seq&&i.value.findIndex(x=>x.seq===C.seq)===-1&&(Number(C.sendUserId)===Number(S.value)||Number(C.recvUserId)===Number(S.value))&&(i.value.push(C),console.log("接收到新格式消息并添加到聊天历史"),d("update-session-preview",{peerId:S.value,preview:C.content.substring(0,30)+(C.content.length>30?"...":""),time:C.createTime||oe(new Date().toISOString()),userName:(R=n.value)==null?void 0:R.peerInfo.userName,userPhoto:(G=n.value)==null?void 0:G.peerInfo.photo}))}else p.content&&p.seq&&i.value.findIndex(U=>U.seq===p.seq)===-1&&(Number(p.sendUserId)===Number(S.value)||Number(p.recvUserId)===Number(S.value))&&(i.value.push(p),console.log("接收到旧格式消息并添加到聊天历史"),d("update-session-preview",{peerId:S.value,preview:p.content.substring(0,30)+(p.content.length>30?"...":""),time:p.createTime||oe(new Date().toISOString()),userName:(N=n.value)==null?void 0:N.peerInfo.userName,userPhoto:(X=n.value)==null?void 0:X.peerInfo.photo}));else if(typeof p=="string"){const C=parseInt(p.trim(),10);if(!isNaN(C)){const U=i.value.findLastIndex(x=>x.seq===0&&Number(x.sendUserId)===Number(m.value));if(U>-1){const x={...i.value[U],seq:C};i.value.splice(U,1,x)}}}}catch(p){console.error("解析消息失败:",p,"原始消息:",_.body)}finally{Z(()=>{re()})}})},function(f){console.error("STOMP连接失败:",f),ce(),r.value=!0,h.value="重连",setTimeout(()=>{(!c||!c.connected)&&(console.log("尝试重新连接WebSocket..."),se())},5e3)}),y.onclose=Se}catch(a){console.error("创建WebSocket连接失败:",a),r.value=!0,h.value="连接失败"}},Ie=async()=>{var y,f;if(!e.value.trim()||!S.value)return;const a=e.value.trim();e.value="";const u={seq:0,recvUserId:Number(S.value),sendUserId:Number(m.value),type:0,content:a,readFlag:!1,status:0,createTime:new Date().toLocaleString("sv-SE",{timeZone:"Asia/Shanghai"}).replace(" ","T")};if(i.value.push(u),await Z(),re(),c&&c.connected)try{c.send(`/app/private/${S.value}`,{ticket:W},JSON.stringify(u)),d("update-session-preview",{peerId:Number(S.value),preview:a,time:u.createTime,userName:(y=n.value)==null?void 0:y.peerInfo.userName,userPhoto:(f=n.value)==null?void 0:f.peerInfo.photo})}catch(_){console.error("WebSocket发送消息失败:",_),h.value="发送失败"}else se(),h.value="发送失败"},Fe=()=>{if(c&&c.connected)try{c.send(it,{ticket:W},"")}catch(a){console.error("发送ping消息失败:",a)}},Pe=()=>{A!==null&&clearInterval(A),A=window.setInterval(Fe,6e4)},ce=()=>{A!==null&&(clearInterval(A),A=null)};function Se(){ce(),c!==null&&c.disconnect(()=>{}),c=null,r.value=!0,h.value="重连"}const re=()=>{Z(()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight,s.value.scroll({top:s.value.scrollHeight+100,behavior:"smooth"}))})},De=async()=>{T.value&&!E.value&&(await le(!0),Z(()=>{s.value&&(s.value.scrollTop=0)}))};return Be(async()=>{var a;S.value&&S.value!==0&&((a=g.global)!=null&&a.isLogin&&m.value&&se(),await Promise.all([le(),we()]),await Z(),re())}),He(()=>{console.log("组件即将卸载，开始清理资源"),ce(),Se(),console.log("组件卸载完成")}),(a,u)=>{var y,f,_,B,z,R,G;return D(),P("div",Ft,[F("div",Pt,[F("div",Dt,[(f=(y=n.value)==null?void 0:y.peerInfo)!=null&&f.photo?(D(),P("img",{key:0,src:(z=(B=(_=n.value)==null?void 0:_.peerInfo)==null?void 0:B.photo)==null?void 0:z.replace(/[`'\s]/g,""),class:"user-avatar cursor-pointer",alt:"用户头像",onClick:u[0]||(u[0]=N=>{var X,p;return q((p=(X=n.value)==null?void 0:X.peerInfo)==null?void 0:p.userId)})},null,8,Wt)):J("",!0),F("span",jt,Q(((G=(R=n.value)==null?void 0:R.peerInfo)==null?void 0:G.userName)||"加载中..."),1)])]),F("div",At,[F("div",{class:"chat-messages",ref_key:"chatMessagesRef",ref:s,style:{flex:"1","overflow-y":"auto",padding:"10px","padding-bottom":"70px"}},[T.value&&!t.value?(D(),P("div",Vt,[F("button",{class:"load-more-button",onClick:De,disabled:E.value},Q(E.value?"加载中...":"查看更多"),9,Bt)])):J("",!0),t.value?(D(),P("div",Ht,"加载中...")):i.value.length===0?(D(),P("div",$t,"暂无聊天记录")):J("",!0),(D(!0),P(de,null,$e(i.value,(N,X)=>{var p,C,U,x,ae,Y;return D(),P("div",{key:N.seq||X,class:ke(["message-wrapper",{"own-message":Number(N.sendUserId)===Number(m.value),"other-message":Number(N.sendUserId)!==Number(m.value)}]),onContextmenu:Ne(fe=>ne(fe,N),["prevent"])},[Number(N.sendUserId)!==Number(m.value)?(D(),P("img",{key:0,src:(U=(C=(p=n.value)==null?void 0:p.peerInfo)==null?void 0:C.photo)==null?void 0:U.replace(/[`'\s]/g,""),class:"message-avatar cursor-pointer",alt:"头像",onClick:u[1]||(u[1]=fe=>{var ee,te;return q((te=(ee=n.value)==null?void 0:ee.peerInfo)==null?void 0:te.userId)})},null,8,Gt)):J("",!0),F("div",Kt,[F("div",{class:ke(["message-bubble",{"recalled-message":N.status===1}])},[N.status===1?(D(),P(de,{key:0},[Jt,F("span",Xt,Q(N.content),1)],64)):(D(),P(de,{key:1},[st(Q(N.content),1)],64))],2),F("div",Yt,Q(oe(N.createTime)),1)]),Number(N.sendUserId)===Number(m.value)?(D(),P("img",{key:1,src:(Y=(ae=(x=n.value)==null?void 0:x.selfInfo)==null?void 0:ae.photo)==null?void 0:Y.replace(/[`'\s]/g,""),class:"message-avatar cursor-pointer",alt:"头像",onClick:u[2]||(u[2]=fe=>{var ee,te;return q((te=(ee=n.value)==null?void 0:ee.selfInfo)==null?void 0:te.userId)})},null,8,Zt)):J("",!0)],42,zt)}),128))],512)]),L.value?(D(),P("div",{key:0,class:"context-menu",style:ze({left:V.value.x+"px",top:V.value.y+"px"}),onClick:u[3]||(u[3]=Ne(()=>{},["stop"]))},[F("div",{class:"menu-item",onClick:Re},"删除"),l.value&&Number(l.value.sendUserId)===Number(m.value)&&Oe(l.value)?(D(),P("div",{key:0,class:"menu-item",onClick:Le}," 撤回 ")):J("",!0)],4)):J("",!0),L.value?(D(),P("div",{key:1,class:"context-menu-backdrop",onClick:K})):J("",!0),F("div",Qt,[Ge(F("input",{"onUpdate:modelValue":u[4]||(u[4]=N=>e.value=N),type:"text",placeholder:"输入消息...",class:"message-input",style:{width:"calc(100% - 80px)",padding:"8px 12px",border:"1px solid #dcdfe6","border-radius":"4px",outline:"none"},onKeyup:Je(Ie,["enter"]),disabled:r.value},null,40,en),[[Ke,e.value]]),F("button",{class:"send-button",onClick:Ie,disabled:!e.value.trim()||r.value,style:{width:"60px",padding:"8px 0","margin-left":"10px","background-color":"#409eff",color:"white",border:"none","border-radius":"4px",cursor:"pointer"}},Q(h.value),9,tn)])])}}}),rn=ct(on,[["__scopeId","data-v-f69c095a"]]);export{rn as default};
