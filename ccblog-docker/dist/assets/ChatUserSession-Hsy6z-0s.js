import H from"./ChatUserView-B2wfaBJJ.js";import{d as B,n as L,o as d,c as p,a as i,t as T,b as _,h as g,x as Y,g as S,e as k,bh as j,y as M,O,I as z,bi as q,bj as $,_ as F,r as E,a1 as G,F as A,i as x,$ as J,l as K,bk as Q,bl as W,a0 as X,a7 as Z,f as R,a8 as ee,D as se,E as oe}from"./index-G4xMqEMQ.js";var u=(l=>(l[l.EMPTY=0]="EMPTY",l[l.DELETE=1]="DELETE",l[l.TOP=2]="TOP",l[l.CANCEL_TOP=3]="CANCEL_TOP",l[l.MUTE=4]="MUTE",l[l.CANCEL_MUTE=5]="CANCEL_MUTE",l))(u||{});const ne={class:"session-avatar"},te=["src"],ae={key:1,class:"avatar-placeholder"},ie={class:"session-info"},le={class:"session-header"},ce={class:"session-name"},de={class:"session-actions"},re={key:0,class:"top-icon"},ue={class:"session-preview"},pe={key:0,class:"unread-badge"},ve=B({__name:"ChatSessionItem",props:{session:{},isSelected:{type:Boolean}},emits:["click","sessionOperated"],setup(l,{emit:s}){const m=l,f=s,y=()=>{f("click",m.session.peerId)},w=o=>{if(![u.DELETE,u.TOP,u.CANCEL_TOP].includes(o))return;const v=m.session.sessionId;z(`${q}/${o}?sessionId=${v}`,{}).then(C=>{C.status===200&&C.data?$.success(o===u.DELETE?"删除会话成功":o===u.TOP?"置顶会话成功":o===u.CANCEL_TOP?"取消置顶成功":"操作成功"):$.error("操作失败，请稍后重试"),(o===u.DELETE||o===u.TOP||o===u.CANCEL_TOP)&&f("sessionOperated",v,o)}).catch(C=>{console.error("会话操作失败:",C),$.error("操作失败，请稍后重试")})},I=o=>{o.stopPropagation()};return(o,h)=>{var b;const v=L("el-dropdown-item"),C=L("el-dropdown-menu"),P=L("el-dropdown");return d(),p("div",{class:O(["chat-session-item",{selected:o.isSelected,"top-session":o.session.isTop}]),onClick:y},[i("div",ne,[o.session.peerPhoto?(d(),p("img",{key:0,src:o.session.peerPhoto,alt:"用户头像",class:"avatar-image"},null,8,te)):(d(),p("div",ae,T(((b=o.session.peerName)==null?void 0:b.charAt(0))||"用"),1))]),i("div",ie,[i("div",le,[i("h4",ce,T(o.session.peerName||"未知用户"),1),i("div",de,[o.session.isTop?(d(),p("div",re,[_(g(Y),{size:"16",color:"#409EFF"})])):S("",!0),_(P,{trigger:"click",onCommand:w},{dropdown:k(()=>[_(C,null,{default:k(()=>[_(v,{command:o.session.isTop?g(u).CANCEL_TOP:g(u).TOP},{icon:k(()=>[_(g(j),{size:"16"})]),default:k(()=>[M(" "+T(o.session.isTop?"取消置顶":"置顶会话"),1)]),_:1},8,["command"]),_(v,{divided:""}),_(v,{command:g(u).DELETE,class:"delete-item"},{default:k(()=>[M(" 删除会话 ")]),_:1},8,["command"])]),_:1})]),default:k(()=>[i("button",{class:"more-btn",title:"操作",onClick:I}," ... ")]),_:1})])]),i("div",ue,[i("span",{class:O(["preview-text",{unread:o.session.unreadCount&&o.session.unreadCount>0}])},T(o.session.snapshot||"暂无消息"),3),o.session.unreadCount&&o.session.unreadCount>0?(d(),p("span",pe,T(o.session.unreadCount>99?"99+":o.session.unreadCount),1)):S("",!0)])])],2)}}}),U=F(ve,[["__scopeId","data-v-650f1f88"]]),V=l=>(se("data-v-c75670c1"),l=l(),oe(),l),_e={class:"chat-main-container"},he={key:0,class:"chat-layout"},fe={class:"chat-list-sidebar"},Ce={class:"chat-list-header",style:{position:"sticky",top:"0","z-index":"100","background-color":"#fafafa"}},me=V(()=>i("h3",null,"私信列表",-1)),Ee={class:"header-actions"},Ie=["disabled"],ke={class:"chat-list-content",style:{height:"calc(100% - 60px)","overflow-y":"auto"}},Te={key:0,class:"loading"},ge={key:1,class:"error"},Pe={key:2,class:"empty-message"},be={class:"chat-detail"},Ne={key:1,class:"full-width-private-list"},Le={class:"private-list-header",style:{position:"sticky",top:"0","z-index":"100","background-color":"#fafafa"}},Se=V(()=>i("h3",null,"私信列表",-1)),ye=["disabled"],we={class:"private-list-content",style:{height:"calc(100% - 60px)","overflow-y":"auto"}},$e={key:0,class:"loading"},Ae={key:1,class:"error"},De={key:2,class:"empty-message"},Me=B({__name:"ChatUserSession",setup(l){const s=E([]),m=E(!1),f=E(!1),y=E(!1),w=J(),I=E(!1),o=async n=>{m.value=!0,f.value=!1;try{const t=await K(Q,{limit:10});y.value=t.data.result.hasMore;let a=t.data.result.chatUserSessionItemDTOS.map(e=>({...e,peerId:Number(e.peerId)||Number(e.userId)||0,peerName:String(e.peerName||e.username||"未知用户"),peerPhoto:String(e.peerPhoto||""),snapshot:String(e.snapshot||""),lastMsgTime:String(e.lastMsgTime||""),unreadCount:Number(e.unreadCount||0)}));if(n){const e=a.find(r=>r.peerId===n);if(e)if(a=a.filter(r=>r.peerId!==n),e.isTop===1)a.unshift(e);else{const r=a.findLastIndex(c=>c.isTop===1);r===-1?a.unshift(e):a.splice(r+1,0,e)}}s.value=a,I.value=s.value.some(e=>e.unreadCount>0),console.log("会话列表:",s.value)}catch(t){console.error("获取会话列表失败:",t),f.value=!0}finally{m.value=!1}};G(async()=>{const n=w.query.peerId,t=n?Number(n):void 0;await o(t),t&&t>0&&setTimeout(()=>{v(t)},100)});const h=E(null),v=n=>{h.value=n;const t=s.value.find(a=>a.peerId===n);t&&(t.unreadCount=0)},C=()=>{h.value=null},P=async()=>{try{(await z(W,{})).data.status.code===0&&(s.value.forEach(t=>{t.unreadCount=0}),I.value=!1,console.log("已清空所有未读消息"))}catch(n){console.error("清空未读消息失败:",n)}},b=n=>{const t=s.value.findIndex(a=>a.peerId===n.peerId);if(t!==-1){s.value[t].snapshot=n.preview,s.value[t].lastMsgTime=n.time,n.userName&&(s.value[t].peerName=n.userName),n.userPhoto&&(s.value[t].peerPhoto=n.userPhoto);const a=s.value[t].isTop===1;if(t>0){const e=s.value.splice(t,1)[0],r=s.value.findLastIndex(c=>c.isTop===1);a?s.value.unshift(e):s.value.splice(r+1,0,e)}}else{const a={peerId:n.peerId,peerName:n.userName||`用户${n.peerId}`,peerPhoto:n.userPhoto||"",snapshot:n.preview,lastMsgTime:n.time,unreadCount:0,id:0,userId:0,isTop:0,isMute:0,isDelete:0,sessionId:void 0},e=s.value.findLastIndex(r=>r.isTop===1);s.value.splice(e+1,0,a),console.log("创建了新会话:",a)}},D=(n,t)=>{switch(t){case u.DELETE:const a=s.value.findIndex(c=>c.sessionId===n);if(a!==-1){const c=s.value[a].peerId;s.value.splice(a,1),h.value===c&&(h.value=null)}break;case u.TOP:const e=s.value.findIndex(c=>c.sessionId===n);if(e!==-1){const c=s.value.splice(e,1)[0];c.isTop=1,s.value.unshift(c)}break;case u.CANCEL_TOP:const r=s.value.findIndex(c=>c.sessionId===n);if(r!==-1){const c=s.value.splice(r,1)[0];c.isTop=0,s.value.push(c)}break}};X("loginDialogClicked",()=>{N.value=!N.value,console.log("clicked: ",N.value)});const N=E(!1);return(n,t)=>{const a=L("LoginDialog");return d(),p(A,null,[_(Z),i("div",_e,[h.value?(d(),p("div",he,[i("div",fe,[i("div",Ce,[me,i("div",Ee,[i("button",{class:"clear-unread-btn",onClick:P,disabled:!I.value},"清空已读",8,Ie),i("button",{class:"close-chat-btn",onClick:C},"退出聊天")])]),i("div",ke,[m.value?(d(),p("div",Te,"加载中...")):f.value?(d(),p("div",ge,"加载失败，请重试")):s.value.length===0?(d(),p("div",Pe,"暂无聊天会话")):S("",!0),(d(!0),p(A,null,x(s.value,(e,r)=>(d(),R(U,{key:e.id||r,session:e,"is-selected":h.value===e.peerId,onClick:c=>v(e.peerId),onSessionOperated:D},null,8,["session","is-selected","onClick"]))),128))])]),i("div",be,[_(H,{"peer-id":h.value,onUpdateSessionPreview:b},null,8,["peer-id"])])])):(d(),p("div",Ne,[i("div",Le,[Se,i("button",{class:"clear-unread-btn",onClick:P,disabled:!I.value},"清空已读",8,ye)]),i("div",we,[m.value?(d(),p("div",$e,"加载中...")):f.value?(d(),p("div",Ae,"加载失败，请重试")):s.value.length===0?(d(),p("div",De,"暂无聊天会话")):S("",!0),(d(!0),p(A,null,x(s.value,(e,r)=>(d(),R(U,{key:e.id||r,session:e,"is-selected":h.value===e.peerId,onClick:c=>v(e.peerId),onSessionOperated:D},null,8,["session","is-selected","onClick"]))),128))])]))]),_(ee),_(a,{clicked:N.value},null,8,["clicked"])],64)}}}),Ue=F(Me,[["__scopeId","data-v-c75670c1"]]);export{Ue as default};
