<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.article.ArticleCountMapper">
<!--    这一段废弃了-->
    <update id="updateCountbyArticleIdBatch">
<!--        拼接后得到的是类似于 update article_count set read_cnt= case article_id(根据这个判断) when 1 ...,when 2 ...,也就是artiicleId不同赋值不同-->
        <!--       case when的else写出来可以避免报错(不变)-->
        UPDATE article_count
        SET
        read_cnt = CASE article_id
        <foreach collection="articleCountList" item="item">
            WHEN #{item.articleId} THEN
            <choose>
                <when test="item.readCnt != null">#{item.readCnt}</when>
                <otherwise>read_cnt</otherwise>
            </choose>
        </foreach>
        ELSE read_cnt
        END,
        like_cnt = CASE article_id
        <foreach collection="articleCountList" item="item">
            WHEN #{item.articleId} THEN
            <choose>
                <when test="item.likeCnt != null">#{item.likeCnt}</when>
                <otherwise>like_cnt</otherwise>
            </choose>
        </foreach>
        ELSE like_cnt
        END,
        collect_cnt = CASE article_id
        <foreach collection="articleCountList" item="item">
            WHEN #{item.articleId} THEN
            <choose>
                <when test="item.collectCnt != null">#{item.collectCnt}</when>
                <otherwise>collect_cnt</otherwise>
            </choose>
        </foreach>
        ELSE collect_cnt
        END,
        comment_cnt = CASE article_id
        <foreach collection="articleCountList" item="item">
            WHEN #{item.articleId} THEN
            <choose>
                <when test="item.commentCnt != null">#{item.commentCnt}</when>
                <otherwise>comment_cnt</otherwise>
            </choose>
        </foreach>
        ELSE comment_cnt
        END,
        update_time = NOW()
        WHERE article_id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.articleId}
        </foreach>
    </update>

    <insert id="upsertDeltaCountBatch">
        INSERT INTO article_count
        (article_id, read_cnt, like_cnt, collect_cnt, comment_cnt, report_cnt, update_time)
        VALUES
        <foreach collection="articleCountList" item="item" separator=",">
            (#{item.articleId},
            <if test="item.readCnt != null">#{item.readCnt}</if>
            <if test="item.readCnt == null">0</if>,
            <if test="item.likeCnt != null">#{item.likeCnt}</if>
            <if test="item.likeCnt == null">0</if>,
            <if test="item.collectCnt != null">#{item.collectCnt}</if>
            <if test="item.collectCnt == null">0</if>,
            <if test="item.commentCnt != null">#{item.commentCnt}</if>
            <if test="item.commentCnt == null">0</if>,
            <if test="item.reportCnt != null">#{item.reportCnt}</if>
            <if test="item.reportCnt == null">0</if>,
            NOW())
        </foreach>
        ON DUPLICATE KEY UPDATE
        read_cnt    = GREATEST(IFNULL(read_cnt,0)   + VALUES(read_cnt), 0),
        like_cnt    = GREATEST(IFNULL(like_cnt,0)   + VALUES(like_cnt), 0),
        collect_cnt = GREATEST(IFNULL(collect_cnt,0) + VALUES(collect_cnt), 0),
        comment_cnt = GREATEST(IFNULL(comment_cnt,0) + VALUES(comment_cnt), 0),
        report_cnt  = GREATEST(IFNULL(report_cnt,0)  + VALUES(report_cnt), 0),
        update_time = NOW()
    </insert>

    <select id="getArticleCountBatch">
        SELECT article_id AS articleId, read_cnt AS readCnt,like_cnt AS likeCnt,collect_cnt AS collectCnt,
        comment_cnt AS commentCnt, report_cnt AS reportCnt
        FROM article_count
        <where>
            article_id IN
            <foreach collection="articleIds" separator="," open="(" close=")" item="articleId">
                #{articleId}
            </foreach>
        </where>
    </select>
</mapper>
