<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.article.ArticleInteractionMapper">
    <insert id="saveOrUpdateArticleInteraction">
        INSERT INTO article_interaction
        (user_id, article_id
        <if test="articleUserId!=null">,article_user_id</if>
        <if test="readStat!=null">,read_stat,first_read_time, last_read_time</if>
        )
        VALUES
        (#{userId},#{articleId}
        <if test="articleUserId!=null">,#{articleUserId}</if>
        <if test="readStat!=null">,#{readStat},NOW(), NOW()</if>
        )
        ON DUPLICATE KEY UPDATE
        <if test="lastReadTime!=null">last_read_time=#{lastReadTime},</if>
        <if test="starStat!=null">star_stat=#{starStat},</if>
        <if test="commentStat!=null">comment_stat=#{commentStat},</if>
        <if test="likeStat!=null">like_stat=#{likeStat},</if>
        <if test="score!=null">score=#{score},</if>
        <if test="readDuration!=null">read_duration=#{readDuration},</if>
        <if test="deleted!=null">deleted=#{deleted},</if>
        <if test="firstReadTime!=null">first_read_time=#{firstReadTime},</if>
        update_time = NOW()
    </insert>

    <insert id="upsertInteractionBatch">
        INSERT INTO article_interaction
        (user_id, article_id, like_stat, collect_stat, read_stat, comment_stat, last_read_time, update_time)
        VALUES
        <foreach collection="articleInteractUpdDTOList" item="item" separator=",">
            (#{item.userId}, #{item.articleId},
            <choose><when test="item.likeStat!=null">#{item.likeStat}</when><otherwise>like_stat</otherwise></choose>,
            <choose><when test="item.collectStat!=null">#{item.collectStat}</when><otherwise>collect_stat</otherwise></choose>,
            <choose><when test="item.readStat!=null">#{item.readStat}</when><otherwise>read_stat</otherwise></choose>,
            <choose><when test="item.commentStat!=null">#{item.commentStat}</when><otherwise>comment_stat</otherwise></choose>,
            <choose><when test="item.lastReadTime!=null">#{item.lastReadTime}</when><otherwise>last_read_time</otherwise></choose>,
            NOW())
        </foreach>
        ON DUPLICATE KEY UPDATE
            like_stat      = VALUES(like_stat),
            collect_stat   = VALUES(collect_stat),
            read_stat      = VALUES(read_stat),
            comment_stat   = VALUES(comment_stat),
            last_read_time = VALUES(last_read_time),
            update_time    = NOW()
    </insert>

<!--    批量获得用户交互状态 -->
    <select id="getUserStatusBatch">
        SELECT article_id AS articleId, user_id AS userId, collect_stat AS collectStatus,like_stat AS likeStatus
               read_stat AS readStatus,comment_stat AS commentStatus
        FROM article_interaction
        WHERE (user_id,article_id) IN
        <foreach collection="idxPairs" separator="," open="(" close=")" item="item">
            (#{item._1},#{item._2})
        </foreach>
    </select>
</mapper>
