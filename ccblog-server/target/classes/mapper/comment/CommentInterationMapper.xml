<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.comment.CommentInteractionMapper">
    <insert id="saveOrUpdateCommentInteraction">
        INSERT INTO comment_interaction
        (user_id, comment_id
        <if test="likeStatus!=null">,like_status</if>
        <if test="dislikeStatus!=null">,dislike_status</if>
        <if test="reportStatus!=null">,report_status</if>
        )
        VALUES
        (#{userId},#{commentId}
        <if test="likeStatus!=null">,#{likeStatus}</if>
        <if test="dislikeStatus!=null">,#{dislikeStatus}</if>
        <if test="reportStatus!=null">,#{reportStatus}</if>
        )
        ON DUPLICATE KEY UPDATE
        <if test="likeStatus!=null">like_status=#{likeStatus},</if>
        <if test="dislikeStatus!=null">dislike_status=#{dislikeStatus},</if>
        <if test="reportStatus!=null">report_status=#{reportStatus},</if>
        update_time = NOW()
    </insert>

    <insert id="upsertInteractionBatch">
        INSERT INTO comment_interaction
        (user_id, comment_id, like_stat, dislike_stat, report_stat, update_time)
        VALUES
        <foreach collection="commentInteractionList" item="item" separator=",">
            (#{item.userId}, #{item.commentId},
            <choose><when test="item.likeStat!=null">#{item.likeStat}</when><otherwise>like_stat</otherwise></choose>,
            <choose><when test="item.dislikeStat!=null">#{item.dislikeStat}</when><otherwise>dislike_stat</otherwise></choose>,
            <choose><when test="item.reportStat!=null">#{item.reportStat}</when><otherwise>report_stat</otherwise></choose>,
            NOW())
        </foreach>
        ON DUPLICATE KEY UPDATE
            like_stat     = VALUES(like_stat),
            dislike_stat  = VALUES(dislike_stat),
            report_stat   = VALUES(report_stat),
            update_time   = NOW()
    </insert>

    <select id="getUserStatusBatch">
        SELECT comment_id AS commentId, user_id AS userId,
        like_stat AS likeStat ,dislike_stat AS dislikeStat
        FROM comment_interaction
        WHERE (user_id,comment_id) IN
        <foreach collection="idxPairs" separator="," open="(" close=")" item="item">
            (#{item._1},#{item._2})
        </foreach>
    </select>
</mapper>
