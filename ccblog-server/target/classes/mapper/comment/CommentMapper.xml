<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.comment.CommentMapper">
    <insert id="saveComment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment(article_id,user_id,content
        <if test="parentCommentId!=null">,top_comment_id,parent_comment_id</if>
        )
        VALUES (
        #{articleId},#{userId},#{content}
        <if test="parentCommentId!=null">,#{topCommentId},#{parentCommentId}</if>
        )
    </insert>

    <select id="listCommentByArticleId">
<!--        获得平铺展开类型的评论数据,先不管因为用不到 -->
        SELECT
        c.id AS commentId,c.top_comment_id,c.parent_comment_id, c.user_id,c.content AS commentContent,
        c.create_time AS commentTime,
        -- 发布者信息
        ui.user_name,ui.photo AS userPhoto
        FROM `comment` c
        LEFT JOIN user_info ui
        ON ui.user_id = c.user_id
        <where>
            c.article_id = #{articleId} AND c.deleted = 0 ;
        </where>
    </select>

    <select id="listByArticleIdAndCommentId">
<!--        批量获得评论信息,用户和交互信息都优化为redis读取 -->
        SELECT
        c.id AS commentId,c.top_comment_id,c.parent_comment_id, c.user_id,c.content AS commentContent,
        c.create_time AS commentTime, c.deleted AS deleted
        FROM `comment` c
        <where>
        c.article_id = #{articleId} AND
        c.parent_comment_id=#{parentId}
        <!--        使用原生sql语句,不然大于小于号会报错-->
        <![CDATA[
            AND (c.create_time < #{cursor} OR (c.create_time = #{cursor} AND c.id > #{cursorId}))
            ORDER BY c.create_time DESC,c.id ASC
    --        多传回一条是方便可以得到是否还有更多
            LIMIT #{limit}
        ]]>
        </where>
    </select>

    <select id="getCommentByCommentId">
        SELECT
        c.id AS commentId,c.top_comment_id,c.parent_comment_id, c.user_id,c.content AS commentContent,
        c.create_time AS commentTime,
        -- 发布者信息
        ui.user_name,ui.photo AS userPhoto
        FROM `comment` c
        LEFT JOIN user_info ui
        ON ui.user_id = c.user_id
        <where>
            c.deleted=0 AND c.id=#{commentId}
        </where>
    </select>

    <select id="getCommInfoByCommId">
        SELECT c.id AS commentId,a.title AS title,a.id AS docId
        FROM `comment` AS c
        LEFT JOIN article AS a ON c.article_id=a.id
        <where>
            c.id in
            <foreach collection='commentIds' item='cid' open='(' separator=',' close=')'>
                #{cid}
            </foreach>
        </where>
    </select>

    <select id="getCommentCursorItem">
        SELECT
        c.id AS commentId,c.top_comment_id,c.parent_comment_id, c.user_id,c.content AS commentContent,
        c.create_time AS commentTime, c.deleted AS deleted,
        -- 发布者信息
        ui.user_name,ui.photo AS userPhoto
        FROM `comment` c
        LEFT JOIN user_info ui
        ON ui.user_id = c.user_id
        <where>
            c.id = #{commentId}
        </where>
    </select>

    <select id="getAllParentIdByCommentId">
<!--       CTE查找  查出来一条编号当前行号,最后只要第一行-->
        WITH RECURSIVE chain AS (
        SELECT id, parent_comment_id
        FROM   comment
        <where>
            id = #{commentId}               -- 要查评论 id
        </where>
        UNION ALL
        SELECT c.id, c.parent_comment_id
        FROM   comment c
<!--       能拼就一直拼,顶级评论的parent_id为0是找不到comment_id匹配的 -->
        JOIN chain p ON c.id = p.parent_comment_id)
        SELECT id
        FROM   chain
        ORDER BY id ASC;              -- 顶级评论节点-目标节点
    </select>

</mapper>
