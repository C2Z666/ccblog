<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccblog.mapper.chat.ChatUserSessionMapper">
   <insert id="upsertSessionBatch">
<!--      tip: 留着delete保证每次有新状态那么会话就会重新显示,isTop不加防止有新状态就重置 -->
       INSERT INTO chat_user_session
       (user_id, peer_id, display_seq,seq, snapshot, last_msg_time, unread_count,
       is_delete, create_time, update_time)
       VALUES
       <foreach collection="chatUserSessions" item="s" separator=",">
           (#{s.userId},
           #{s.peerId},
           <if test="s.displaySeq != null">#{s.displaySeq}</if><if test="s.displaySeq == null">0</if>,
           <if test="s.seq != null">#{s.seq}</if><if test="s.seq == null">0</if>,
           #{s.snapshot},
           #{s.lastMsgTime},
           <if test="s.unreadCount != null">#{s.unreadCount}</if><if test="s.unreadCount == null">0</if>,
           <if test="s.isDelete != null">#{s.isDelete}</if><if test="s.isDelete == null">0</if>,
           NOW(),
           NOW())
       </foreach>
       ON DUPLICATE KEY UPDATE
       snapshot      = VALUES(snapshot),
       last_msg_time = VALUES(last_msg_time),
       display_seq   = VALUES(display_seq),
       seq   = VALUES(seq),
       unread_count  = VALUES(unread_count),
       is_delete     = VALUES(is_delete),
       update_time   = NOW()
   </insert>

    <select id="getCursorSessionByUserId">
        SELECT
        id          AS sessionId,
        user_id     AS userId,
        peer_id     AS peerId,
        snapshot,
        last_msg_time AS lastMsgTime,
        unread_count AS unreadCount,
        is_top      AS isTop,
        is_mute     AS isMute,
        last_msg_time AS cursorLastMsgTime,
        id          AS cursorId
        FROM chat_user_session
        WHERE user_id = #{userId}
        AND is_delete = 0
        <![CDATA[
            AND (last_msg_time, id) < (#{cursor}, #{cursorId})
        ]]>
        ORDER BY is_top DESC, last_msg_time DESC, id DESC
        LIMIT #{limit}
    </select>


</mapper>
